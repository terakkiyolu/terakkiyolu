<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ERT HALI - YÃ¶netici Paneli</title>

   PWA Meta 
  <meta name="theme-color" content="#0f172a">
  <meta name="description" content="ERT HALI YÃ¶netici Paneli - SatÄ±ÅŸ, Gider, MÃ¼ÅŸteri, ÃœrÃ¼n ve Depo YÃ¶netimi">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ERT HALI">

   Icons (lokal dosyalarÄ±nÄ±z varsa) 
  <link rel="icon" type="image/png" sizes="192x192" href="ert1.png">
  <link rel="apple-touch-icon" href="ert1.png">
  <link rel="manifest" href="manifest.json">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; outline:none; -webkit-tap-highlight-color:transparent; user-select:none; }
    input, textarea, select { user-select:text; }
    :root{
      --bg-primary:#ffffff; --bg-secondary:#f8fafc; --bg-tertiary:#f1f5f9;
      --text-primary:#0f172a; --text-secondary:#64748b; --border-color:#e2e8f0;
      --shadow:rgba(0,0,0,0.08); --shadow-dark:rgba(0,0,0,0.15);
      --danger-color:#dc2626; --warning-color:#f59e0b; --success-color:#059669; --info-color:#0ea5e9;
      --primary-color:#0f172a; --sidebar-width:288px; --header-height:56px;
    }
    [data-theme="dark"]{
      --bg-primary:#0f172a; --bg-secondary:#1e293b; --bg-tertiary:#334155;
      --text-primary:#ffffff; --text-secondary:#94a3b8; --border-color:#334155;
      --shadow:rgba(255,255,255,0.08); --shadow-dark:rgba(255,255,255,0.15);
    }
    body{ font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg-primary); color:var(--text-primary); line-height:1.5; transition:all .3s; }

    .ripple { position:relative; overflow:hidden; }
    .ripple::before{content:''; position:absolute; inset:auto; top:50%; left:50%; width:0; height:0; border-radius:50%; background:rgba(15,23,42,.15); transform:translate(-50%,-50%); transition:width .6s,height .6s;}
    .ripple:active::before{ width:300px; height:300px; }

    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:40; display:none; }
    .overlay.show{ display:block; }

    .sidebar{ position:fixed; left:0; top:0; width:var(--sidebar-width); height:100vh; background:var(--bg-primary); border-right:1px solid var(--border-color); z-index:50; transform:translateX(-100%); transition:transform .3s; }
    .sidebar.open{ transform:translateX(0); }
    @media(min-width:1024px){ .sidebar{ transform:translateX(0); } }
    .sidebar-header{ height:var(--header-height); display:flex; align-items:center; gap:12px; padding:0 16px; border-bottom:1px solid var(--border-color); }
    .sidebar-logo{ width:32px; height:32px; border-radius:6px; object-fit:cover; background:#eee; }
    .sidebar-title{ font-weight:700; }

    .sidebar-nav{ padding:8px; height:calc(100vh - var(--header-height)); overflow:auto; display:flex; flex-direction:column; }
    .nav-section{ flex:1; }
    .nav-item{ display:flex; gap:10px; align-items:center; padding:10px 12px; color:var(--text-secondary); border-radius:8px; cursor:pointer; transition:.2s; text-decoration:none;}
    .nav-item:hover, .nav-item.active{ background:var(--bg-tertiary); color:var(--text-primary); }
    .nav-footer{ border-top:1px solid var(--border-color); padding-top:8px; }

    .main-content{ margin-left:0; min-height:100vh; }
    @media(min-width:1024px){ .main-content{ margin-left:var(--sidebar-width); } }

    .header{ height:var(--header-height); position:sticky; top:0; z-index:40; background:var(--bg-primary); border-bottom:1px solid var(--border-color); display:flex; align-items:center; gap:16px; padding:0 16px; }
    .menu-toggle{ display:block; border:none; background:transparent; color:var(--text-secondary); padding:8px; border-radius:6px; }
    @media(min-width:1024px){ .menu-toggle{ display:none; } }
    .search-container{ flex:1; max-width:360px; position:relative; }
    .search-input{ width:100%; padding:8px 12px 8px 12px; border:1px solid var(--border-color); border-radius:6px; background:var(--bg-primary); color:var(--text-primary); }
    .search-input:focus{ border-color:var(--primary-color); box-shadow:0 0 0 3px rgba(15,23,42,.1); }

    .header-actions{ display:flex; align-items:center; gap:8px; }
    .header-btn{ border:none; background:transparent; color:var(--text-secondary); padding:8px; border-radius:6px; }
    .header-btn:hover{ background:var(--bg-tertiary); }

    .file-status{ position:fixed; top:70px; right:20px; background:var(--success-color); color:#fff; padding:8px 14px; border-radius:18px; font-size:.75rem; font-weight:700; z-index:999; display:none; box-shadow:0 4px 12px var(--shadow-dark); }
    .file-status.error{ background:var(--danger-color); }
    .file-status.warning{ background:var(--warning-color); color:#000; }

    .page-content{ padding:16px; }
    @media(min-width:768px){ .page-content{ padding:24px; } }
    @media(min-width:1024px){ .page-content{ padding:32px; } }
    .page-header{ margin-bottom:24px; }
    .page-title{ font-size:24px; font-weight:800; margin-bottom:6px; }
    @media(min-width:768px){ .page-title{ font-size:30px; } }
    .page-description{ color:var(--text-secondary); font-size:14px; }

    .tabs{ margin-bottom:20px; }
    .tab-list{ display:flex; gap:4px; background:var(--bg-tertiary); border-radius:8px; padding:4px; width:max-content; }
    .tab-trigger{ border:none; background:transparent; color:var(--text-secondary); padding:8px 12px; border-radius:6px; cursor:pointer; }
    .tab-trigger.active{ background:var(--bg-primary); color:var(--text-primary); box-shadow:0 1px 3px rgba(0,0,0,.1); }

    .card{ background:var(--bg-primary); border:1px solid var(--border-color); border-radius:10px; overflow:hidden; margin-bottom:16px; }
    .card-header{ padding:14px 16px; border-bottom:1px solid var(--border-color); display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .card-title{ font-weight:700; }
    .card-description{ color:var(--text-secondary); font-size:13px; }
    .card-content{ padding:16px; }

    .stats-grid{ display:grid; gap:16px; grid-template-columns:1fr; }
    @media(min-width:640px){ .stats-grid{ grid-template-columns:repeat(2,1fr);} }
    @media(min-width:1024px){ .stats-grid{ grid-template-columns:repeat(4,1fr);} }
    .stat-card{ background:var(--bg-primary); border:1px solid var(--border-color); border-radius:10px; padding:16px; transition:.25s; cursor:pointer; }
    .stat-card:hover{ transform:translateY(-2px); box-shadow:0 4px 12px var(--shadow-dark); }
    .stat-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; color:var(--text-secondary);}
    .stat-title{ font-size:13px; }
    .stat-value{ font-size:24px; font-weight:800; }
    .stat-change{ font-size:12px; color:var(--text-secondary); }
    .stat-change.positive{ color:var(--success-color); }
    .stat-change.negative{ color:var(--danger-color); }

    .form-group{ margin-bottom:14px; }
    .form-row{ display:grid; gap:16px; grid-template-columns:1fr; }
    @media(min-width:768px){ .form-row{ grid-template-columns:repeat(2,1fr);} }
    label{ display:block; margin-bottom:8px; font-weight:600; font-size:14px; }
    input, select, textarea{ width:100%; padding:8px 12px; border:1px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary); }
    input:focus, select:focus, textarea:focus{ border-color:var(--primary-color); box-shadow:0 0 0 3px rgba(15,23,42,.1); }

    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
    .btn-primary{ background:var(--primary-color); color:#fff; }
    .btn-secondary{ background:transparent; color:var(--text-primary); border:1px solid var(--border-color); }
    .btn-danger{ background:var(--danger-color); color:#fff; }
    .btn-warning{ background:var(--warning-color); color:#fff; }
    .btn-success{ background:var(--success-color); color:#fff; }
    .btn-ghost{ background:transparent; color:var(--text-secondary); }
    .btn-small{ padding:6px 10px; font-size:12px; }

    .payment-options{ display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; }
    .payment-option{ padding:12px; border:1px solid var(--border-color); border-radius:8px; text-align:center; cursor:pointer; font-weight:600; background:var(--bg-primary); }
    .payment-option.selected{ background:var(--primary-color); color:#fff; border-color:var(--primary-color); }

    .table-container{ overflow:auto; border:1px solid var(--border-color); border-radius:10px; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ text-align:left; padding:12px; border-bottom:1px solid var(--border-color); font-size:14px; }
    th{ color:var(--text-secondary); background:var(--bg-secondary); font-weight:700; }

    .status-badge{ display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; }
    .status-active{ background:#dcfce7; color:#166534; }
    .status-pending{ background:#fef3c7; color:#92400e; }

    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:2000; padding:16px; }
    .modal-content{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--bg-primary); border:1px solid var(--border-color); border-radius:10px; padding:20px; width:100%; max-width:640px; max-height:90vh; overflow:auto; box-shadow:0 20px 60px rgba(0,0,0,.3); }
    .close{ position:absolute; top:12px; right:12px; width:32px; height:32px; border-radius:50%; border:none; background:transparent; color:var(--text-secondary); cursor:pointer; }
    .close:hover{ background:var(--bg-secondary); }

    .customer-item{ padding:16px; border:1px solid var(--border-color); border-radius:10px; margin-bottom:10px; transition:.2s; }
    .customer-item:hover{ background:var(--bg-secondary); transform:translateY(-1px); box-shadow:0 2px 8px var(--shadow); }
    .customer-name{ font-weight:800; margin-bottom:4px; }
    .customer-info{ color:var(--text-secondary); display:flex; gap:10px; flex-wrap:wrap; font-size:13px; }

    .alert{ padding:12px 14px; border-radius:10px; margin-bottom:14px; border:1px solid var(--border-color); display:flex; gap:8px; align-items:center; font-weight:700; }
    .alert-success{ background:rgba(5,150,105,.08); color:var(--success-color); border-color:var(--success-color); }
    .alert-error{ background:rgba(220,38,38,.08); color:var(--danger-color); border-color:var(--danger-color); }
    .alert-warning{ background:rgba(245,158,11,.08); color:var(--warning-color); border-color:var(--warning-color); }

    /* Depo kartlarÄ± */
    .warehouse-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:16px; }
    .product-card{ border:1px solid var(--border-color); border-radius:10px; padding:14px; background:var(--bg-primary); display:flex; flex-direction:column; gap:8px; }
    .product-title{ font-weight:800; }
    .product-code{ font-size:12px; color:var(--text-secondary); }
    .stock-badge{ align-self:flex-start; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800; }
    .stock-ok{ background:#e0f2fe; color:#075985; }
    .stock-low{ background:#fee2e2; color:#991b1b; }

    /* MÃ¼ÅŸteri autocomplete */
    .customer-autocomplete{ position:relative; }
    .customer-suggestions{ position:absolute; top:100%; left:0; right:0; background:var(--bg-primary); border:1px solid var(--border-color); border-top:none; border-radius:0 0 10px 10px; max-height:220px; overflow:auto; display:none; z-index:100; }
    .customer-suggestion{ padding:10px 12px; border-bottom:1px solid var(--border-color); cursor:pointer; }
    .customer-suggestion:hover, .customer-suggestion.selected{ background:var(--bg-secondary); }

    .hidden-mobile{ display:none; }
    @media(min-width:768px){ .hidden-mobile{ display:block; } }
    .text-right{ text-align:right; } .text-center{ text-align:center; }
    .mb-1{ margin-bottom:8px; } .mb-2{ margin-bottom:16px; } .mb-3{ margin-bottom:24px; }
    .mt-1{ margin-top:8px; } .mt-2{ margin-top:16px; } .mt-3{ margin-top:24px; }
    .d-flex{ display:flex; } .align-center{ align-items:center; } .justify-between{ justify-content:space-between; } .gap-1{ gap:8px; } .gap-2{ gap:16px; }
    .w-full{ width:100%; }
  </style>
</head>
<body>
  <div id="fileStatus" class="file-status">Dosya Sistemi HazÄ±r</div>
  <div id="overlay" class="overlay"></div>

   Sidebar 
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <img src="the1.png" alt="ERT HALI Logo" class="sidebar-logo" />
      <div class="sidebar-title">ERT HALI</div>
      <button id="sidebarClose" class="header-btn ripple" style="margin-left:auto;">X</button>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">
        <a class="nav-item ripple active" data-page="dashboard">Panel</a>
        <a class="nav-item ripple" data-page="sales">SatÄ±ÅŸ</a>
        <a class="nav-item ripple" data-page="expenses">Gider</a>
        <a class="nav-item ripple" data-page="customers">MÃ¼ÅŸteri</a>
        <a class="nav-item ripple" data-page="warehouse">Depo</a>
        <a class="nav-item ripple" data-page="reports">Rapor</a>
        <a class="nav-item ripple" data-page="data">Veri</a>
      </div>
      <div class="nav-footer">
        <a class="nav-item ripple" onclick="showAdminLogin()">YÃ¶netici</a>
        <a class="nav-item ripple" onclick="toggleTheme()" id="themeToggle">Tema</a>
      </div>
    </nav>
  </aside>

   Main 
  <div class="main-content">
    <header class="header">
      <button id="menuToggle" class="menu-toggle ripple">â˜°</button>
      <div class="search-container">
        <input type="search" class="search-input" placeholder="Ara..." />
      </div>
      <div class="header-actions">
        <button class="header-btn ripple" onclick="showPendingPayments()">
          BorÃ§lar <span id="debtBadge" style="display:none; margin-left:6px; background:#dc2626; color:#fff; border-radius:999px; padding:2px 8px; font-size:10px;">0</span>
        </button>
        <button class="header-btn ripple" onclick="toggleTheme()">â˜¾</button>
      </div>
    </header>

    <div id="mainApp">
      <main class="page-content">
         Dashboard 
        <section id="dashboard-page" class="page">
          <div class="page-header">
            <h1 class="page-title">Genel Durum</h1>
            <p class="page-description">Ä°ÅŸletmenizin genel performansÄ± ve istatistikleri</p>
          </div>

          <div class="tabs">
            <div class="tab-list">
              <button class="tab-trigger ripple active" data-tab="today">BugÃ¼n</button>
              <button class="tab-trigger ripple" data-tab="week">Bu Hafta</button>
              <button class="tab-trigger ripple" data-tab="month">Bu Ay</button>
            </div>
          </div>

          <div class="stats-grid mb-2">
            <div class="stat-card ripple">
              <div class="stat-header"><span class="stat-title">Gelir</span><span>â‚º</span></div>
              <div id="totalSales" class="stat-value">0</div>
              <div id="salesChange" class="stat-change positive">+0%</div>
            </div>
            <div class="stat-card ripple">
              <div class="stat-header"><span class="stat-title">Gider</span><span>â‚º</span></div>
              <div id="totalExpenses" class="stat-value">0</div>
              <div id="expensesChange" class="stat-change negative">+0%</div>
            </div>
            <div class="stat-card ripple">
              <div class="stat-header"><span class="stat-title">Net Kar</span><span>â‚º</span></div>
              <div id="netProfit" class="stat-value">0</div>
              <div id="profitChange" class="stat-change">0%</div>
            </div>
            <div class="stat-card ripple" onclick="showPendingPayments()">
              <div class="stat-header"><span class="stat-title">Toplam BorÃ§</span>âš </div>
              <div id="totalDebt" class="stat-value">0</div>
              <div class="stat-change">TÃ¼m Zamanlar</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Son Ä°ÅŸlemler</h3>
              <p class="card-description">En son gerÃ§ekleÅŸtirilen iÅŸlemler</p>
            </div>
            <div class="card-content" style="padding:0;">
              <div class="table-container">
                <table>
                  <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>TÃ¼r</th>
                    <th>AÃ§Ä±klama</th>
                    <th>Tutar</th>
                    <th>Ã–deme</th>
                    <th>Ã‡alÄ±ÅŸan</th>
                  </tr>
                  </thead>
                  <tbody id="recentTransactions"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

         Sales 
        <section id="sales-page" class="page" style="display:none;">
          <div class="page-header">
            <h1 class="page-title">SatÄ±ÅŸ GiriÅŸi</h1>
            <p class="page-description">Yeni satÄ±ÅŸ iÅŸlemi kaydedin (ÃœrÃ¼n/Adet bazlÄ±)</p>
          </div>

          <div class="card">
            <div class="card-content">
              <form id="salesForm">
                <div class="form-row">
                  <div class="form-group customer-autocomplete">
                    <label for="customerName">MÃ¼ÅŸteri AdÄ± <small>(F1 ile seÃ§)</small></label>
                    <input id="customerName" type="text" required />
                    <div id="customerSuggestions" class="customer-suggestions"></div>
                  </div>
                  <div class="form-group">
                    <label for="customerSurname">MÃ¼ÅŸteri SoyadÄ±</label>
                    <input id="customerSurname" type="text" required />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="customerPhone">Telefon</label>
                    <input id="customerPhone" type="tel" required />
                  </div>
                  <div class="form-group">
                    <label for="productSelect">ÃœrÃ¼n</label>
                    <select id="productSelect" required>
                      <option value="">ÃœrÃ¼n SeÃ§in</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="quantity">Adet</label>
                    <input id="quantity" type="number" min="1" step="1" value="1" required />
                  </div>
                  <div class="form-group">
                    <label for="unitPrice">Birim Fiyat (â‚º)</label>
                    <input id="unitPrice" type="number" step="0.01" required />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="salePrice">Toplam Fiyat (â‚º)</label>
                    <input id="salePrice" type="number" step="0.01" required />
                  </div>
                  <div class="form-group">
                    <label for="employeeCode">Ã‡alÄ±ÅŸan Kodu</label>
                    <input id="employeeCode" type="password" maxlength="3" required />
                  </div>
                </div>

                <div class="form-group">
                  <label>Ã–deme TÃ¼rÃ¼</label>
                  <div class="payment-options">
                    <div class="payment-option ripple selected" data-type="cash" onclick="selectPaymentType('cash')">Nakit</div>
                    <div class="payment-option ripple" data-type="card" onclick="selectPaymentType('card')">Kart</div>
                    <div class="payment-option ripple" data-type="debt" onclick="selectPaymentType('debt')">BorÃ§</div>
                  </div>
                </div>

                <div id="debtOptions" style="display:none;">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="paidAmount">Ã–denen Tutar (â‚º)</label>
                      <input id="paidAmount" type="number" step="0.01" value="0" />
                    </div>
                    <div class="form-group" id="paidPaymentTypeGroup">
                      <label>Ã–denen KÄ±smÄ±n TÃ¼rÃ¼</label>
                      <div class="payment-options">
                        <div class="payment-option ripple selected" onclick="selectPaidPaymentType('cash')">Nakit</div>
                        <div class="payment-option ripple" onclick="selectPaidPaymentType('card')">Kart</div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="alert alert-warning mb-2" id="stockInfo" style="display:none;"></div>

                <button type="submit" class="btn btn-primary w-full">SatÄ±ÅŸÄ± Kaydet</button>
              </form>
            </div>
          </div>
        </section>

         Expenses 
        <section id="expenses-page" class="page" style="display:none;">
          <div class="page-header">
            <h1 class="page-title">Gider GiriÅŸi</h1>
            <p class="page-description">Yeni gider kaydÄ± oluÅŸturun</p>
          </div>

          <div class="card">
            <div class="card-content">
              <form id="expensesForm">
                <div class="form-row">
                  <div class="form-group">
                    <label for="expenseDescription">Gider AÃ§Ä±klamasÄ±</label>
                    <input id="expenseDescription" type="text" required />
                  </div>
                  <div class="form-group">
                    <label for="expenseAmount">Gider TutarÄ± (â‚º)</label>
                    <input id="expenseAmount" type="number" step="0.01" required />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="expenseCategory">Kategori</label>
                    <select id="expenseCategory" required>
                      <option value="">Kategori SeÃ§in</option>
                      <option value="kira">Kira</option>
                      <option value="elektrik">Elektrik</option>
                      <option value="su">Su</option>
                      <option value="telefon">Telefon</option>
                      <option value="malzeme">Malzeme</option>
                      <option value="personel">Personel</option>
                      <option value="diger">DiÄŸer</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="expenseEmployeeCode">Ã‡alÄ±ÅŸan Kodu</label>
                    <input id="expenseEmployeeCode" type="password" maxlength="3" required />
                  </div>
                </div>
                <button type="submit" class="btn btn-primary w-full">Gider Kaydet</button>
              </form>
            </div>
          </div>
        </section>

         Customers 
        <section id="customers-page" class="page" style="display:none;">
          <div class="page-header">
            <h1 class="page-title">MÃ¼ÅŸteri Listesi</h1>
            <p class="page-description">TÃ¼m mÃ¼ÅŸterilerinizi gÃ¶rÃ¼ntÃ¼leyin ve yÃ¶netin</p>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="search-container" style="max-width:320px;">
                <input id="customerSearch" type="text" class="search-input" placeholder="MÃ¼ÅŸteri ara..." onkeyup="searchCustomers()">
              </div>
              <div class="card-description">Toplam: <span id="customerCount">0</span></div>
            </div>
            <div class="card-content">
              <div id="customersList"></div>
            </div>
          </div>
        </section>

         Warehouse 
        <section id="warehouse-page" class="page" style="display:none;">
          <div class="page-header">
            <h1 class="page-title">Depo</h1>
            <p class="page-description">ÃœrÃ¼nler ve stok adetlerini gÃ¶rÃ¼ntÃ¼leyin</p>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="search-container" style="max-width:320px;">
                <input id="warehouseSearch" type="text" class="search-input" placeholder="ÃœrÃ¼n ara (kod/isim)" oninput="renderWarehouse()" />
              </div>
              <div class="d-flex gap-1">
                <button class="btn btn-secondary" onclick="renderWarehouse()">Yenile</button>
              </div>
            </div>
            <div class="card-content">
              <div id="warehouseGrid" class="warehouse-grid"></div>
            </div>
          </div>
        </section>

         Reports 
        <section id="reports-page" class="page" style="display:none;">
          <div class="page-header">
            <h1 class="page-title">Raporlar</h1>
            <p class="page-description">DetaylÄ± raporlar ve analizler</p>
          </div>

          <div class="card">
            <div class="card-content">
              <div class="form-row">
                <div class="form-group">
                  <label for="reportType">Rapor TÃ¼rÃ¼</label>
                  <select id="reportType">
                    <option value="daily">GÃ¼nlÃ¼k</option>
                    <option value="monthly">AylÄ±k</option>
                    <option value="yearly">YÄ±llÄ±k</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="reportDate">Tarih</label>
                  <input id="reportDate" type="date" />
                </div>
              </div>
              <div class="d-flex gap-2 mb-3">
                <button class="btn btn-primary" onclick="generateReport()">Rapor OluÅŸtur</button>
                <button class="btn btn-secondary" onclick="downloadReport()">Rapor Ä°ndir</button>
              </div>

              <div id="reportContent"></div>
            </div>
          </div>
        </section>

         Data 
        <section id="data-page" class="page" style="display:none;">
          <div class="page-header">
            <h1 class="page-title">Veri YÃ¶netimi</h1>
            <p class="page-description">Verilerinizi yÃ¶netin ve yedekleyin</p>
          </div>

          <div class="card">
            <div class="card-content">
              <div class="form-group">
                <button class="btn btn-primary w-full mb-1" onclick="selectDataFile()">Veri DosyasÄ± SeÃ§</button>
                <p class="page-description">BilgisayarÄ±nÄ±zdan bir JSON veri dosyasÄ± seÃ§in</p>
              </div>
              <div class="form-group">
                <button class="btn btn-success w-full mb-1" onclick="saveDataToFile()">Verileri Kaydet</button>
                <p class="page-description">Mevcut verileri seÃ§ili dosyaya kaydeder</p>
              </div>
              <div class="form-group">
                <button class="btn btn-warning w-full mb-1" onclick="createNewDataFile()">Yeni Dosya OluÅŸtur</button>
                <p class="page-description">Yeni bir veri dosyasÄ± oluÅŸturur</p>
              </div>
              <div class="form-group">
                <button class="btn btn-danger w-full mb-1" onclick="clearAllData()">TÃ¼m Verileri Temizle</button>
                <p class="page-description">âš  Bu iÅŸlem geri alÄ±namaz!</p>
              </div>

              <div id="fileInfo" class="card" style="display:none; margin-top:16px;">
                <div class="card-header">
                  <h3 class="card-title">Dosya Bilgileri</h3>
                </div>
                <div class="card-content">
                  <p><strong>SeÃ§ili Dosya:</strong> <span id="selectedFileName">-</span></p>
                  <p><strong>Son GÃ¼ncelleme:</strong> <span id="lastUpdate">-</span></p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

     Admin 
    <div id="adminPage" class="admin-page" style="display:none;">
      <main class="page-content">
        <div class="page-header">
          <h1 class="page-title">YÃ¶netici Paneli</h1>
          <p class="page-description">GeliÅŸmiÅŸ iÅŸlem ve analiz merkezi</p>
        </div>

        <div class="admin-nav" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px; margin-bottom:16px;">
          <button class="admin-nav-btn btn btn-secondary" data-section="overview" onclick="showAdminSection('overview')">Genel BakÄ±ÅŸ</button>
          <button class="admin-nav-btn btn btn-secondary" data-section="sales" onclick="showAdminSection('sales')">SatÄ±ÅŸ YÃ¶netimi</button>
          <button class="admin-nav-btn btn btn-secondary" data-section="expenses" onclick="showAdminSection('expenses')">Gider YÃ¶netimi</button>
          <button class="admin-nav-btn btn btn-secondary" data-section="employees" onclick="showAdminSection('employees')">Ã‡alÄ±ÅŸan YÃ¶netimi</button>
          <button class="admin-nav-btn btn btn-secondary" data-section="products" onclick="showAdminSection('products')">ÃœrÃ¼n YÃ¶netimi</button>
          <button class="admin-nav-btn btn btn-secondary" data-section="analytics" onclick="showAdminSection('analytics')">Analitik</button>
          <button class="admin-nav-btn btn btn-primary" onclick="goBackToMain()">Ana Sayfa</button>
        </div>

         Overview 
        <section id="adminOverview" class="admin-content" style="display:block;">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Genel BakÄ±ÅŸ</h3>
              <input id="adminDateFilter" type="date" onchange="filterAdminData()" />
            </div>
            <div class="card-content">
              <div class="stats-grid">
                <div class="stat-card ripple"><div class="stat-header"><span>GÃ¼nlÃ¼k Gelir</span>â‚º</div><div id="adminTotalSales" class="stat-value">0</div></div>
                <div class="stat-card ripple"><div class="stat-header"><span>GÃ¼nlÃ¼k Gider</span>â‚º</div><div id="adminTotalExpenses" class="stat-value">0</div></div>
                <div class="stat-card ripple"><div class="stat-header"><span>GÃ¼nlÃ¼k Kar</span>â‚º</div><div id="adminNetProfit" class="stat-value">0</div></div>
                <div class="stat-card ripple"><div class="stat-header"><span>Ä°ÅŸlem SayÄ±sÄ±</span>ðŸ”¢</div><div id="adminTotalTransactions" class="stat-value">0</div></div>
              </div>
            </div>
          </div>
        </section>

         Sales Admin 
        <section id="adminSales" class="admin-content" style="display:none;">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">SatÄ±ÅŸ Ä°ÅŸlemleri</h3>
              <input id="salesDateFilter" type="date" onchange="loadAdminSales()"/>
            </div>
            <div class="card-content" style="padding:0;">
              <div class="table-container">
                <table>
                  <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>MÃ¼ÅŸteri</th>
                    <th>ÃœrÃ¼n</th>
                    <th>Adet</th>
                    <th>Tutar</th>
                    <th>Ã–deme</th>
                    <th>Ã‡alÄ±ÅŸan</th>
                    <th>Ä°ÅŸlemler</th>
                  </tr>
                  </thead>
                  <tbody id="adminSalesTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

         Expenses Admin 
        <section id="adminExpenses" class="admin-content" style="display:none;">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Gider Ä°ÅŸlemleri</h3>
              <input id="expensesDateFilter" type="date" onchange="loadAdminExpenses()"/>
            </div>
            <div class="card-content" style="padding:0;">
              <div class="table-container">
                <table>
                  <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>AÃ§Ä±klama</th>
                    <th>Kategori</th>
                    <th>Tutar</th>
                    <th>Ã‡alÄ±ÅŸan</th>
                    <th>Ä°ÅŸlemler</th>
                  </tr>
                  </thead>
                  <tbody id="adminExpensesTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

         Employees 
        <section id="adminEmployees" class="admin-content" style="display:none;">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Ã‡alÄ±ÅŸan YÃ¶netimi</h3>
              <button class="btn btn-primary" onclick="showAddEmployeeModal()">Yeni Ã‡alÄ±ÅŸan Ekle</button>
            </div>
            <div class="card-content">
              <div id="employeeGrid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px;"></div>
            </div>
          </div>
        </section>

         Products 
        <section id="adminProducts" class="admin-content" style="display:none;">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ÃœrÃ¼n YÃ¶netimi</h3>
            </div>
            <div class="card-content">
              <form id="addProductForm" class="mb-2">
                <div class="form-row">
                  <div class="form-group">
                    <label for="productCode">ÃœrÃ¼n Kodu</label>
                    <input id="productCode" type="text" required />
                  </div>
                  <div class="form-group">
                    <label for="productName">ÃœrÃ¼n AdÄ±</label>
                    <input id="productName" type="text" required />
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="productUnitPrice">Birim Fiyat (â‚º)</label>
                    <input id="productUnitPrice" type="number" step="0.01" required />
                  </div>
                  <div class="form-group">
                    <label for="productInitialStock">BaÅŸlangÄ±Ã§ Stok</label>
                    <input id="productInitialStock" type="number" min="0" step="1" value="0" required />
                  </div>
                </div>
                <button type="submit" class="btn btn-primary">ÃœrÃ¼n Ekle</button>
              </form>

              <div class="table-container">
                <table>
                  <thead>
                  <tr>
                    <th>Kod</th>
                    <th>Ad</th>
                    <th>Birim Fiyat</th>
                    <th>Stok</th>
                    <th>Ä°ÅŸlemler</th>
                  </tr>
                  </thead>
                  <tbody id="productsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

         Analytics 
        <section id="adminAnalytics" class="admin-content" style="display:none;">
          <div class="card">
            <div class="card-header"><h3 class="card-title">Analitik</h3></div>
            <div class="card-content">
              <div class="stats-grid">
                <div class="stat-card ripple"><div class="stat-header"><span>Ortalama SatÄ±ÅŸ</span>â‚º</div><div id="analyticsAvgSale" class="stat-value">0</div></div>
                <div class="stat-card ripple"><div class="stat-header"><span>En Aktif Ã‡alÄ±ÅŸan</span>ðŸ‘¤</div><div id="analyticsTopEmployee" class="stat-value">-</div></div>
                <div class="stat-card ripple"><div class="stat-header"><span>AylÄ±k BÃ¼yÃ¼me</span>%</div><div id="analyticsMonthlyGrowth" class="stat-value">0%</div></div>
                <div class="stat-card ripple"><div class="stat-header"><span>Toplam MÃ¼ÅŸteri</span>ðŸ‘¥</div><div id="analyticsCustomerCount" class="stat-value">0</div></div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

   Modals 
  <div id="adminLoginModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="closeAdminLogin()">âœ•</button>
      <h3 class="card-title mb-2">YÃ¶netici GiriÅŸi</h3>
      <div class="form-group">
        <label for="adminCode">YÃ¶netici Kodu</label>
        <input id="adminCode" type="password" maxlength="3" placeholder="Kodu girin" />
      </div>
      <button class="btn btn-danger w-full" onclick="verifyAdmin()">GiriÅŸ Yap</button>
    </div>
  </div>

  <div id="addEmployeeModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="closeAddEmployeeModal()">âœ•</button>
      <h3 class="card-title mb-2">Yeni Ã‡alÄ±ÅŸan Ekle</h3>
      <form id="addEmployeeForm">
        <div class="form-group">
          <label for="employeeName">Ã‡alÄ±ÅŸan AdÄ±</label>
          <input id="employeeName" type="text" required />
        </div>
        <div class="form-group">
          <label for="employeeCodeNew">Ã‡alÄ±ÅŸan Kodu (3 haneli)</label>
          <input id="employeeCodeNew" type="text" maxlength="3" required />
        </div>
        <button type="submit" class="btn btn-primary w-full">Ã‡alÄ±ÅŸan Ekle</button>
      </form>
    </div>
  </div>

  <div id="editSaleModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="closeEditSale()">âœ•</button>
      <h3 class="card-title mb-2">SatÄ±ÅŸ DÃ¼zenle</h3>
      <form id="editSaleForm">
        <div class="form-row">
          <div class="form-group">
            <label for="editCustomerName">MÃ¼ÅŸteri AdÄ±</label>
            <input id="editCustomerName" type="text" required />
          </div>
          <div class="form-group">
            <label for="editCustomerSurname">MÃ¼ÅŸteri SoyadÄ±</label>
            <input id="editCustomerSurname" type="text" required />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editCustomerPhone">Telefon</label>
            <input id="editCustomerPhone" type="tel" required />
          </div>
          <div class="form-group">
            <label for="editQuantity">Adet</label>
            <input id="editQuantity" type="number" min="1" step="1" required />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editUnitPrice">Birim Fiyat (â‚º)</label>
            <input id="editUnitPrice" type="number" step="0.01" required />
          </div>
          <div class="form-group">
            <label for="editSalePrice">Toplam (â‚º)</label>
            <input id="editSalePrice" type="number" step="0.01" required />
          </div>
        </div>
        <button type="submit" class="btn btn-primary w-full">GÃ¼ncelle</button>
      </form>
    </div>
  </div>

  <div id="editExpenseModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="closeEditExpense()">âœ•</button>
      <h3 class="card-title mb-2">Gider DÃ¼zenle</h3>
      <form id="editExpenseForm">
        <div class="form-group">
          <label for="editExpenseDescription">AÃ§Ä±klama</label>
          <input id="editExpenseDescription" type="text" required />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editExpenseAmount">Tutar (â‚º)</label>
            <input id="editExpenseAmount" type="number" step="0.01" required />
          </div>
          <div class="form-group">
            <label for="editExpenseCategory">Kategori</label>
            <select id="editExpenseCategory" required>
              <option value="kira">Kira</option>
              <option value="elektrik">Elektrik</option>
              <option value="su">Su</option>
              <option value="telefon">Telefon</option>
              <option value="malzeme">Malzeme</option>
              <option value="personel">Personel</option>
              <option value="diger">DiÄŸer</option>
            </select>
          </div>
        </div>
        <button type="submit" class="btn btn-primary w-full">GÃ¼ncelle</button>
      </form>
    </div>
  </div>

  <div id="editProductModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="closeEditProduct()">âœ•</button>
      <h3 class="card-title mb-2">ÃœrÃ¼n DÃ¼zenle</h3>
      <form id="editProductForm">
        <div class="form-row">
          <div class="form-group">
            <label for="editProductCode">ÃœrÃ¼n Kodu</label>
            <input id="editProductCode" type="text" required />
          </div>
          <div class="form-group">
            <label for="editProductName">ÃœrÃ¼n AdÄ±</label>
            <input id="editProductName" type="text" required />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editProductUnitPrice">Birim Fiyat (â‚º)</label>
            <input id="editProductUnitPrice" type="number" step="0.01" required />
          </div>
          <div class="form-group">
            <label>Mevcut Stok</label>
            <div id="editProductStock" class="card-description">0</div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary w-full">Kaydet</button>
      </form>
    </div>
  </div>

  <div id="adjustStockModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="closeAdjustStock()">âœ•</button>
      <h3 class="card-title mb-2">Stok Ayarla</h3>
      <div class="form-group">
        <label>ÃœrÃ¼n</label>
        <div id="adjustStockProductInfo" class="card-description"></div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="stockChangeType">Ä°ÅŸlem</label>
          <select id="stockChangeType">
            <option value="increase">ArtÄ±r</option>
            <option value="decrease">Azalt</option>
          </select>
        </div>
        <div class="form-group">
          <label for="stockChangeQty">Adet</label>
          <input id="stockChangeQty" type="number" min="1" step="1" value="1" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="stockChangeReason">Sebep</label>
          <input id="stockChangeReason" type="text" placeholder="Ã–rn: sayÄ±m farkÄ±, tedarik, iade..." />
        </div>
        <div class="form-group">
          <label for="stockChangeEmployeeCode">Ã‡alÄ±ÅŸan Kodu</label>
          <input id="stockChangeEmployeeCode" type="password" maxlength="3" />
        </div>
      </div>
      <button class="btn btn-primary w-full" onclick="applyStockAdjustment()">Uygula</button>
    </div>
  </div>

  <div id="customerModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="closeCustomerModal()">âœ•</button>
      <div id="customerDetails"></div>
    </div>
  </div>

  <div id="paymentsModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="closePaymentsModal()">âœ•</button>
      <h3 class="card-title mb-2">Bekleyen Ã–demeler</h3>
      <div id="pendingPaymentsList"></div>
    </div>
  </div>

  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="closePaymentModal()">âœ•</button>
      <h3 class="card-title mb-2">Ã–deme Al</h3>
      <div class="form-group">
        <label>MÃ¼ÅŸteri</label>
        <div id="paymentCustomerInfo" class="card-description"></div>
      </div>
      <div class="form-group">
        <label>Toplam BorÃ§</label>
        <div id="paymentTotalDebt" style="color:var(--danger-color); font-weight:800; font-size:18px;"></div>
      </div>
      <div class="form-group">
        <label for="paymentAmount">Ã–deme TutarÄ± (â‚º)</label>
        <input id="paymentAmount" type="number" step="0.01" required />
      </div>
      <div class="form-group">
        <label>Ã–deme TÃ¼rÃ¼</label>
        <div class="payment-options">
          <div class="payment-option ripple selected" onclick="selectDebtPaymentType('cash')">Nakit</div>
          <div class="payment-option ripple" onclick="selectDebtPaymentType('card')">Kart</div>
        </div>
      </div>
      <div class="form-group">
        <label for="paymentEmployeeCode">Ã‡alÄ±ÅŸan Kodu</label>
        <input id="paymentEmployeeCode" type="password" maxlength="3" required />
      </div>
      <button class="btn btn-primary w-full" onclick="processPayment()">Ã–deme Al</button>
    </div>
  </div>

  <script>
    // PWA / FS
    let fileHandle = null;
    const isFileSystemSupported = 'showOpenFilePicker' in window;

    // Employees (varsayÄ±lanlar)
    let employees = { '222':'YUSUF', '333':'YUNUS' };
    const ADMIN_CODE = '666';

    // Data
    let salesData = [];
    let expensesData = [];
    let customersData = [];
    let debtsData = [];
    let paymentsData = [];
    let productsData = []; // { code, name, unitPrice, stock }
    let stockMovements = []; // { id, date, productCode, change, reason, employee }

    // UI State
    let selectedPaymentType = 'cash';
    let selectedPaidPaymentType = 'cash';
    let selectedDebtPaymentType = 'cash';
    let currentPaymentCustomer = null;
    let isAdminLoggedIn = false;
    let currentEditSaleId = null;
    let currentEditExpenseId = null;
    let currentEditProductCode = null;
    let currentDashboardPeriod = 'today';
    let selectedCustomerIndex = -1;
    let customerSuggestions = [];
    let isShowingSuggestions = false;
    let adjustStockProduct = null;

    // Sidebar & overlay
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const menuToggle = document.getElementById('menuToggle');
    const sidebarClose = document.getElementById('sidebarClose');
    function toggleSidebar(){ sidebar.classList.toggle('open'); overlay.classList.toggle('show'); }
    menuToggle.addEventListener('click', toggleSidebar);
    sidebarClose.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', toggleSidebar);

    // Navigation
    const navItems = document.querySelectorAll('.nav-item[data-page]');
    const pages = document.querySelectorAll('.page');
    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        navItems.forEach(n => n.classList.remove('active'));
        item.classList.add('active');
        pages.forEach(p => p.style.display = 'none');
        const pageId = item.getAttribute('data-page') + '-page';
        const target = document.getElementById(pageId);
        if (target) target.style.display = 'block';

        const pageName = item.getAttribute('data-page');
        if (pageName === 'dashboard') updateDashboard();
        if (pageName === 'customers') loadCustomers();
        if (pageName === 'warehouse') renderWarehouse();

        if (window.innerWidth < 1024) toggleSidebar();
      });
    });

    // Tabs
    const tabTriggers = document.querySelectorAll('.tab-trigger');
    tabTriggers.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tabTriggers.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const name = btn.getAttribute('data-tab');
        currentDashboardPeriod = name;
        updateDashboard();
      });
    });

    // Theme
    function toggleTheme(){
      const body = document.body;
      if (body.getAttribute('data-theme') === 'dark'){
        body.removeAttribute('data-theme');
        localStorage.setItem('ertHaliTheme','light');
      }else{
        body.setAttribute('data-theme','dark');
        localStorage.setItem('ertHaliTheme','dark');
      }
    }
    function loadTheme(){
      const saved = localStorage.getItem('ertHaliTheme');
      if (saved==='dark'){ document.body.setAttribute('data-theme','dark'); }
    }

    // File helpers
    function showAlert(message, type='success'){
      const div = document.createElement('div');
      div.className = `alert alert-${type}`;
      div.textContent = message;
      document.body.appendChild(div);
      Object.assign(div.style,{ position:'fixed', top:'80px', left:'50%', transform:'translateX(-50%)', zIndex:9999, maxWidth:'90%' });
      setTimeout(()=>div.remove(), 3500);
    }
    function showFileStatus(msg,type='success'){
      const el = document.getElementById('fileStatus');
      el.textContent = msg;
      el.className = `file-status ${type}`;
      el.style.display = 'block';
      setTimeout(()=> el.style.display='none', 3000);
    }
    function updateFileInfo(){
      if (fileHandle){
        document.getElementById('selectedFileName').textContent = fileHandle.name;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('tr-TR');
        document.getElementById('fileInfo').style.display = 'block';
      }
    }
    async function autoSave(){
      if (fileHandle){ await saveDataToFile(); }
    }

    async function selectDataFile(){
      if (!isFileSystemSupported){ showAlert('File System Access API desteklenmiyor','error'); return; }
      try{
        [fileHandle] = await window.showOpenFilePicker({
          types:[{ description:'JSON', accept:{'application/json':['.json']} }],
          excludeAcceptAllOption:true, multiple:false
        });
        localStorage.setItem('ertHaliFileHandleMeta', JSON.stringify({ name:fileHandle.name, kind:fileHandle.kind }));
        await loadDataFromFile();
        updateFileInfo();
        showFileStatus('Dosya seÃ§ildi ve yÃ¼klendi','success');
      }catch(e){ if (e.name!=='AbortError'){ console.error(e); showAlert('Dosya seÃ§me hatasÄ±: '+e.message,'error'); } }
    }

    async function loadDataFromFile(){
      if (!fileHandle) return;
      try{
        const file = await fileHandle.getFile();
        const txt = await file.text();
        if (txt.trim()===''){ initializeEmptyData(); }
        else{
          const data = JSON.parse(txt);
          salesData = data.sales || [];
          expensesData = data.expenses || [];
          customersData = data.customers || [];
          debtsData = data.debts || [];
          paymentsData = data.payments || [];
          productsData = data.products || [];
          stockMovements = data.stockMovements || [];

          if (data.employees){ employees = { ...employees, ...data.employees }; }
        }
        hydrateUIFromData();
        showAlert('Veriler dosyadan yÃ¼klendi','success');
      }catch(e){ console.error(e); showAlert('Dosya okuma hatasÄ±: '+e.message,'error'); }
    }

    async function saveDataToFile(){
      if (!fileHandle){ showAlert('Ã–nce bir dosya seÃ§in!','error'); return; }
      try{
        const data = {
          sales:salesData, expenses:expensesData, customers:customersData, debts:debtsData,
          payments:paymentsData, products:productsData, stockMovements, employees, lastUpdate:new Date().toISOString()
        };
        const w = await fileHandle.createWritable();
        await w.write(JSON.stringify(data,null,2));
        await w.close();
        updateFileInfo();
        showFileStatus('Veriler kaydedildi','success');
      }catch(e){ console.error(e); showAlert('Dosya yazma hatasÄ±: '+e.message,'error'); showFileStatus('Kaydetme hatasÄ±','error'); }
    }

    async function createNewDataFile(){
      if (!isFileSystemSupported){ showAlert('File System Access API desteklenmiyor','error'); return; }
      try{
        fileHandle = await window.showSaveFilePicker({
          types:[{ description:'JSON', accept:{'application/json':['.json']} }],
          suggestedName:`ert-hali-data-${new Date().toISOString().split('T')[0]}.json`
        });
        localStorage.setItem('ertHaliFileHandleMeta', JSON.stringify({ name:fileHandle.name, kind:fileHandle.kind }));
        await saveDataToFile();
        updateFileInfo();
        showFileStatus('Yeni dosya oluÅŸturuldu','success');
      }catch(e){ if (e.name!=='AbortError'){ console.error(e); showAlert('Dosya oluÅŸturma hatasÄ±: '+e.message,'error'); } }
    }

    function initializeEmptyData(){
      salesData=[]; expensesData=[]; customersData=[]; debtsData=[]; paymentsData=[]; productsData=[]; stockMovements=[];
    }

    function hydrateUIFromData(){
      loadTheme();
      fillProductsToSelect();
      renderWarehouse();
      updateDashboard();
      updateDebtBadge();
      if (isAdminLoggedIn){ loadAdminData(); loadEmployees(); loadProductsAdmin(); }
    }

    // Date ranges
    function getDateRange(period){
      const now=new Date();
      let startDate, endDate;
      if (period==='today'){ startDate=new Date(now.getFullYear(),now.getMonth(),now.getDate()); endDate=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1); }
      else if (period==='week'){ const ws= now.getDate() - now.getDay(); startDate=new Date(now.getFullYear(),now.getMonth(),ws); endDate=new Date(now.getFullYear(),now.getMonth(),ws+7); }
      else if (period==='month'){ startDate=new Date(now.getFullYear(),now.getMonth(),1); endDate=new Date(now.getFullYear(),now.getMonth()+1,1); }
      else { startDate=new Date(now.getFullYear(),now.getMonth(),now.getDate()); endDate=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1); }
      return { startDate, endDate };
    }

    // Employees
    function verifyEmployeeCode(code){ return employees[code] || null; }

    // Payment UI
    function selectPaymentType(type){
      selectedPaymentType = type;
      document.querySelectorAll('#sales-page .payment-option').forEach(o=>o.classList.remove('selected'));
      const target = Array.from(document.querySelectorAll('#sales-page .payment-option')).find(el=>el.getAttribute('data-type')===type) || event.target.closest('.payment-option');
      if (target) target.classList.add('selected');
      document.getElementById('debtOptions').style.display = (type==='debt' ? 'block' : 'none');
    }
    function selectPaidPaymentType(type){
      selectedPaidPaymentType = type;
      document.querySelectorAll('#paidPaymentTypeGroup .payment-option').forEach(o=>o.classList.remove('selected'));
      (event.target.closest('.payment-option')||null)?.classList.add('selected');
    }
    function selectDebtPaymentType(type){
      selectedDebtPaymentType = type;
      document.querySelectorAll('#paymentModal .payment-option').forEach(o=>o.classList.remove('selected'));
      (event.target.closest('.payment-option')||null)?.classList.add('selected');
    }
    function getPaymentTypeDisplay(t){ return t==='cash'?'Nakit': t==='card'?'Kart': t==='debt'?'BorÃ§': t; }

    // Customers
    function updateCustomer(name, surname, phone, saleData){
      const idx = customersData.findIndex(c=> c.phone===phone);
      if (idx!==-1){
        customersData[idx].sales.push(saleData);
        customersData[idx].totalPurchases += saleData.salePrice;
        customersData[idx].lastPurchase = saleData.date;
      }else{
        customersData.push({
          id: Date.now() + Math.floor(Math.random()*1000),
          name, surname, phone,
          totalPurchases: saleData.salePrice,
          lastPurchase: saleData.date,
          sales: [saleData]
        });
      }
    }

    function loadCustomers(){
      // TÃ¼m mÃ¼ÅŸterileri ada gÃ¶re sÄ±ralayÄ±p bas
      const list = document.getElementById('customersList');
      const sorted = [...customersData].sort((a,b)=> a.name.localeCompare(b.name, 'tr'));
      list.innerHTML = sorted.map(c=>`
        <div class="customer-item ripple" onclick="showCustomerDetails('${c.id}')">
          <div class="customer-name">${c.name} ${c.surname}</div>
          <div class="customer-info">
            <span>ðŸ“ž ${c.phone}</span>
            <span>ðŸ’³ ${c.totalPurchases.toLocaleString('tr-TR')} â‚º</span>
            <span>ðŸ—“ ${new Date(c.lastPurchase).toLocaleDateString('tr-TR')}</span>
          </div>
        </div>
      `).join('');
      document.getElementById('customerCount').textContent = customersData.length;
    }

    function searchCustomers(){
      const term = (document.getElementById('customerSearch').value||'').toLowerCase();
      const filtered = customersData.filter(c => 
        c.name.toLowerCase().includes(term) ||
        c.surname.toLowerCase().includes(term) ||
        c.phone.includes(term)
      );
      const list = document.getElementById('customersList');
      list.innerHTML = filtered.map(c=>`
        <div class="customer-item ripple" onclick="showCustomerDetails('${c.id}')">
          <div class="customer-name">${c.name} ${c.surname}</div>
          <div class="customer-info">
            <span>ðŸ“ž ${c.phone}</span>
            <span>ðŸ’³ ${c.totalPurchases.toLocaleString('tr-TR')} â‚º</span>
            <span>ðŸ—“ ${new Date(c.lastPurchase).toLocaleDateString('tr-TR')}</span>
          </div>
        </div>
      `).join('');
      document.getElementById('customerCount').textContent = filtered.length;
    }

    function showCustomerDetails(customerId){
      const c = customersData.find(x=> String(x.id)===String(customerId));
      if (!c) return;
      const custDebts = debtsData.filter(d=> d.customerPhone===c.phone);
      const custPayments = paymentsData.filter(p=> p.customerPhone===c.phone);

      document.getElementById('customerDetails').innerHTML = `
        <h3 class="card-title mb-2">ðŸ‘¤ ${c.name} ${c.surname}</h3>
        <div class="card mb-2">
          <div class="card-content" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px;">
            <div><strong>Telefon:</strong><br><span class="card-description">${c.phone}</span></div>
            <div><strong>Toplam AlÄ±ÅŸveriÅŸ:</strong><br><span style="color:var(--success-color); font-weight:800;">${c.totalPurchases.toLocaleString('tr-TR')} â‚º</span></div>
            <div><strong>Son AlÄ±ÅŸveriÅŸ:</strong><br><span class="card-description">${new Date(c.lastPurchase).toLocaleDateString('tr-TR')}</span></div>
            ${custDebts.length>0 ? `<div><strong>BorÃ§:</strong><br><span style="color:var(--danger-color); font-weight:800;">${custDebts.reduce((s,d)=> s+d.remainingAmount,0).toLocaleString('tr-TR')} â‚º</span></div>`:''}
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h4 class="card-title">AlÄ±ÅŸveriÅŸ GeÃ§miÅŸi</h4></div>
          <div class="card-content" style="padding:0;">
            <div class="table-container">
              <table>
                <thead><tr><th>Tarih</th><th>ÃœrÃ¼n</th><th>Adet</th><th>Birim</th><th>Toplam</th><th>Ã–deme</th><th>Ã‡alÄ±ÅŸan</th></tr></thead>
                <tbody>
                  ${c.sales.map(s=>`
                    <tr>
                      <td>${new Date(s.date).toLocaleDateString('tr-TR')}</td>
                      <td>${s.productCode || '-'} ${s.productName? ' - '+s.productName : ''}</td>
                      <td>${s.quantity ?? '-'}</td>
                      <td>${(s.unitPrice ?? 0).toLocaleString('tr-TR')} â‚º</td>
                      <td>${s.salePrice.toLocaleString('tr-TR')} â‚º</td>
                      <td><span class="status-badge status-active">${getPaymentTypeDisplay(s.paidPaymentType)}</span>${s.paymentType==='debt'?' <span style="color:var(--danger-color);">(BorÃ§)</span>':''}</td>
                      <td>${s.employee}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        ${custPayments.length>0 ? `
          <div class="card">
            <div class="card-header"><h4 class="card-title">Ã–deme GeÃ§miÅŸi</h4></div>
            <div class="card-content" style="padding:0;">
              <div class="table-container">
                <table>
                  <thead><tr><th>Tarih</th><th>Tutar</th><th>Ã–deme</th><th>Ã‡alÄ±ÅŸan</th></tr></thead>
                  <tbody>
                    ${custPayments.map(p=>`
                      <tr>
                        <td>${new Date(p.date).toLocaleDateString('tr-TR')}</td>
                        <td style="color:var(--success-color);">${p.amount.toLocaleString('tr-TR')} â‚º</td>
                        <td><span class="status-badge status-active">${getPaymentTypeDisplay(p.paymentType)}</span></td>
                        <td>${p.employee}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `:''}
      `;
      document.getElementById('customerModal').style.display='block';
    }

    // Customer Autocomplete
    function setupCustomerAutocomplete(){
      const nameInput = document.getElementById('customerName');
      const suggestionsDiv = document.getElementById('customerSuggestions');

      nameInput.addEventListener('input', function(){
        const q = this.value.toLowerCase();
        if (q.length < 2){ hideSuggestions(); return; }
        customerSuggestions = customersData.filter(c => 
          c.name.toLowerCase().includes(q) ||
          c.surname.toLowerCase().includes(q) ||
          String(c.phone).includes(q)
        ).slice(0,8);
        showSuggestions();
      });

      nameInput.addEventListener('keydown', function(e){
        if (e.key==='F1'){
          e.preventDefault();
          customerSuggestions = customersData.slice(0,10);
          showSuggestions();
        }else if (e.key==='ArrowDown'){
          e.preventDefault();
          if (isShowingSuggestions){
            selectedCustomerIndex = Math.min(selectedCustomerIndex+1, customerSuggestions.length-1);
            updateSuggestionSelection();
          }
        }else if (e.key==='ArrowUp'){
          e.preventDefault();
          if (isShowingSuggestions){
            selectedCustomerIndex = Math.max(selectedCustomerIndex-1, -1);
            updateSuggestionSelection();
          }
        }else if (e.key==='Enter'){
          if (isShowingSuggestions && selectedCustomerIndex>=0){
            e.preventDefault();
            selectCustomer(customerSuggestions[selectedCustomerIndex]);
          }
        }else if (e.key==='Escape'){
          hideSuggestions();
        }
      });

      document.addEventListener('click', (e)=>{
        if (!nameInput.contains(e.target) && !suggestionsDiv.contains(e.target)){ hideSuggestions(); }
      });
    }
    function showSuggestions(){
      const suggestionsDiv = document.getElementById('customerSuggestions');
      suggestionsDiv.innerHTML = customerSuggestions.map((c,i)=>`
        <div class="customer-suggestion ${i===selectedCustomerIndex?'selected':''}" onclick='selectCustomer(${JSON.stringify(c).replace(/"/g,'&quot;')})'>
          <strong>${c.name} ${c.surname}</strong><br/>
          <small>${c.phone} - ${c.totalPurchases.toLocaleString('tr-TR')} â‚º</small>
        </div>
      `).join('');
      suggestionsDiv.style.display='block'; isShowingSuggestions=true; selectedCustomerIndex=-1;
    }
    function hideSuggestions(){ document.getElementById('customerSuggestions').style.display='none'; isShowingSuggestions=false; selectedCustomerIndex=-1; }
    function updateSuggestionSelection(){ document.querySelectorAll('.customer-suggestion').forEach((el,i)=> el.classList.toggle('selected', i===selectedCustomerIndex)); }
    function selectCustomer(c){
      document.getElementById('customerName').value = c.name;
      document.getElementById('customerSurname').value = c.surname;
      document.getElementById('customerPhone').value = c.phone;
      hideSuggestions();
    }

    // Products
    function fillProductsToSelect(){
      const sel = document.getElementById('productSelect');
      const prev = sel.value;
      sel.innerHTML = `<option value="">ÃœrÃ¼n SeÃ§in</option>` + productsData.map(p=>`<option value="${p.code}">${p.code} - ${p.name}</option>`).join('');
      if (productsData.find(p=>p.code===prev)) sel.value = prev;
      // Reflect selection info
      updateSalePricingFromSelection();
    }

    function loadProductsAdmin(){
      const tbody = document.getElementById('productsTable');
      tbody.innerHTML = productsData.map(p=>`
        <tr>
          <td>${p.code}</td>
          <td>${p.name}</td>
          <td>${p.unitPrice.toLocaleString('tr-TR')} â‚º</td>
          <td>${p.stock}</td>
          <td class="d-flex gap-1">
            <button class="btn btn-warning btn-small" onclick="openEditProduct('${p.code}')">DÃ¼zenle</button>
            <button class="btn btn-secondary btn-small" onclick="openAdjustStock('${p.code}')">Stok</button>
            <button class="btn btn-danger btn-small" onclick="deleteProduct('${p.code}')">Sil</button>
          </td>
        </tr>
      `).join('');
    }

    function renderWarehouse(){
      const grid = document.getElementById('warehouseGrid');
      const q = (document.getElementById('warehouseSearch')?.value||'').toLowerCase();
      const filtered = productsData.filter(p => p.code.toLowerCase().includes(q) || p.name.toLowerCase().includes(q));
      grid.innerHTML = filtered.map(p=>{
        const low = p.stock <= 3;
        return `
          <div class="product-card ripple">
            <div class="product-title">${p.name}</div>
            <div class="product-code">Kod: ${p.code}</div>
            <div>Fiyat: <strong>${p.unitPrice.toLocaleString('tr-TR')} â‚º</strong></div>
            <div class="stock-badge ${low?'stock-low':'stock-ok'}">Stok: ${p.stock} ${low?'(DÃ¼ÅŸÃ¼k)':''}</div>
            <div class="d-flex gap-1 mt-1">
              <button class="btn btn-secondary btn-small" onclick="openAdjustStock('${p.code}')">Stok Ayarla</button>
              <button class="btn btn-warning btn-small" onclick="openEditProduct('${p.code}')">DÃ¼zenle</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Add product form
    document.getElementById('addProductForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const code = document.getElementById('productCode').value.trim().toUpperCase();
      const name = document.getElementById('productName').value.trim();
      const unitPrice = parseFloat(document.getElementById('productUnitPrice').value);
      const initialStock = parseInt(document.getElementById('productInitialStock').value, 10);
      if (!code || !name || isNaN(unitPrice) || isNaN(initialStock)){ showAlert('GeÃ§ersiz Ã¼rÃ¼n bilgisi','error'); return; }
      if (productsData.find(p=>p.code===code)){ showAlert('Bu Ã¼rÃ¼n kodu zaten mevcut','error'); return; }

      productsData.push({ code, name, unitPrice, stock: initialStock });
      stockMovements.push({ id: Date.now(), date:new Date().toISOString(), productCode:code, change: initialStock, reason:'BaÅŸlangÄ±Ã§ Stok', employee:'SÄ°STEM' });
      (e.target).reset();
      await autoSave();
      fillProductsToSelect();
      loadProductsAdmin();
      renderWarehouse();
      showAlert('ÃœrÃ¼n eklendi','success');
    });

    function openEditProduct(code){
      const p = productsData.find(x=>x.code===code); if (!p) return;
      currentEditProductCode = code;
      document.getElementById('editProductCode').value = p.code;
      document.getElementById('editProductName').value = p.name;
      document.getElementById('editProductUnitPrice').value = p.unitPrice;
      document.getElementById('editProductStock').textContent = p.stock;
      document.getElementById('editProductModal').style.display='block';
    }
    function closeEditProduct(){ currentEditProductCode=null; document.getElementById('editProductModal').style.display='none'; }

    document.getElementById('editProductForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const p = productsData.find(x=>x.code===currentEditProductCode);
      if (!p) return;
      const newCode = document.getElementById('editProductCode').value.trim().toUpperCase();
      const newName = document.getElementById('editProductName').value.trim();
      const newUnit = parseFloat(document.getElementById('editProductUnitPrice').value);
      if (!newCode || !newName || isNaN(newUnit)){ showAlert('GeÃ§ersiz bilgi','error'); return; }
      if (newCode!==p.code && productsData.find(x=>x.code===newCode)){ showAlert('Kod kullanÄ±mda','error'); return; }

      // Update product code references (sales & stock movements) if changed
      if (newCode!==p.code){
        salesData.forEach(s=>{ if (s.productCode===p.code) s.productCode=newCode; });
        stockMovements.forEach(m=>{ if (m.productCode===p.code) m.productCode=newCode; });
        p.code = newCode;
      }
      p.name = newName;
      p.unitPrice = newUnit;
      await autoSave();
      fillProductsToSelect();
      loadProductsAdmin();
      renderWarehouse();
      closeEditProduct();
      showAlert('ÃœrÃ¼n gÃ¼ncellendi','success');
    });

    async function deleteProduct(code){
      // Engelle: ÃœrÃ¼ne baÄŸlÄ± satÄ±ÅŸ varsa silmeyelim
      if (salesData.some(s=> s.productCode===code)){
        showAlert('Bu Ã¼rÃ¼ne ait satÄ±ÅŸ kayÄ±tlarÄ± var, silinemez','error');
        return;
      }
      if (!confirm('Bu Ã¼rÃ¼nÃ¼ silmek istiyor musunuz?')) return;
      const idx = productsData.findIndex(p=>p.code===code);
      if (idx>-1){ productsData.splice(idx,1); await autoSave(); loadProductsAdmin(); fillProductsToSelect(); renderWarehouse(); showAlert('ÃœrÃ¼n silindi','success'); }
    }

    function openAdjustStock(code){
      const p = productsData.find(x=>x.code===code); if (!p) return;
      adjustStockProduct = p;
      document.getElementById('adjustStockProductInfo').textContent = `${p.code} - ${p.name} | Mevcut Stok: ${p.stock}`;
      document.getElementById('stockChangeType').value='increase';
      document.getElementById('stockChangeQty').value='1';
      document.getElementById('stockChangeReason').value='';
      document.getElementById('stockChangeEmployeeCode').value='';
      document.getElementById('adjustStockModal').style.display='block';
    }
    function closeAdjustStock(){ adjustStockProduct=null; document.getElementById('adjustStockModal').style.display='none'; }

    async function applyStockAdjustment(){
      if (!adjustStockProduct) return;
      const type = document.getElementById('stockChangeType').value;
      const qty = parseInt(document.getElementById('stockChangeQty').value,10);
      const reason = document.getElementById('stockChangeReason').value || (type==='increase'?'Stok ArtÄ±ÅŸ':'Stok AzalÄ±ÅŸ');
      const empCode = document.getElementById('stockChangeEmployeeCode').value;
      const empName = verifyEmployeeCode(empCode);
      if (!empName){ showAlert('GeÃ§ersiz Ã§alÄ±ÅŸan kodu','error'); return; }
      if (isNaN(qty) || qty<=0){ showAlert('GeÃ§ersiz adet','error'); return; }
      if (type==='decrease' && adjustStockProduct.stock<qty){ showAlert('Yeterli stok yok','error'); return; }

      const delta = type==='increase' ? qty : -qty;
      adjustStockProduct.stock += delta;
      stockMovements.push({ id: Date.now(), date:new Date().toISOString(), productCode:adjustStockProduct.code, change: delta, reason, employee: empName });
      await autoSave();
      fillProductsToSelect();
      loadProductsAdmin();
      renderWarehouse();
      closeAdjustStock();
      showAlert('Stok gÃ¼ncellendi','success');
    }

    // Sales Form helpers for product/price
    function updateSalePricingFromSelection(){
      const code = document.getElementById('productSelect').value;
      const qEl = document.getElementById('quantity');
      const unitEl = document.getElementById('unitPrice');
      const totalEl = document.getElementById('salePrice');
      const info = document.getElementById('stockInfo');
      const prod = productsData.find(p=>p.code===code);
      if (prod){
        unitEl.value = String(prod.unitPrice);
        const qty = parseInt(qEl.value||'1',10);
        totalEl.value = String((prod.unitPrice * (isNaN(qty)?1:qty)).toFixed(2));
        info.style.display='block';
        info.textContent = `SeÃ§ili Ã¼rÃ¼n stok: ${prod.stock}`;
      }else{
        info.style.display='none';
      }
    }
    document.getElementById('productSelect').addEventListener('change', updateSalePricingFromSelection);
    document.getElementById('quantity').addEventListener('input', ()=>{
      const qty = parseInt(document.getElementById('quantity').value||'1',10);
      const unit = parseFloat(document.getElementById('unitPrice').value||'0');
      document.getElementById('salePrice').value = isNaN(qty) || isNaN(unit) ? '' : String((qty*unit).toFixed(2));
      updateSalePricingFromSelection();
    });
    document.getElementById('unitPrice').addEventListener('input', ()=>{
      const qty = parseInt(document.getElementById('quantity').value||'1',10);
      const unit = parseFloat(document.getElementById('unitPrice').value||'0');
      document.getElementById('salePrice').value = isNaN(qty) || isNaN(unit) ? '' : String((qty*unit).toFixed(2));
    });

    // Debt badge
    function updateDebtBadge(){
      const count = debtsData.length;
      const badge = document.getElementById('debtBadge');
      if (count>0){ badge.textContent = count; badge.style.display='inline-block'; }
      else{ badge.style.display='none'; }
    }

    // Admin login
    function showAdminLogin(){ document.getElementById('adminLoginModal').style.display='block'; }
    function closeAdminLogin(){ document.getElementById('adminLoginModal').style.display='none'; document.getElementById('adminCode').value=''; }
    function verifyAdmin(){
      const code = document.getElementById('adminCode').value;
      if (code===ADMIN_CODE){
        isAdminLoggedIn = true;
        document.getElementById('mainApp').style.display='none';
        document.getElementById('adminPage').style.display='block';
        closeAdminLogin();
        loadAdminData(); loadEmployees(); loadProductsAdmin();
        showAlert('YÃ¶netici paneline giriÅŸ yapÄ±ldÄ±','success');
      }else{
        showAlert('GeÃ§ersiz yÃ¶netici kodu','error');
      }
    }
    function goBackToMain(){
      document.getElementById('adminPage').style.display='none';
      document.getElementById('mainApp').style.display='block';
      updateDashboard();
    }
    function showAdminSection(name){
      document.querySelectorAll('.admin-content').forEach(s=> s.style.display='none');
      const el = document.getElementById('admin'+ name.charAt(0).toUpperCase()+name.slice(1));
      if (el) el.style.display='block';
      if (name==='sales') loadAdminSales();
      if (name==='expenses') loadAdminExpenses();
      if (name==='employees') loadEmployees();
      if (name==='products') loadProductsAdmin();
      if (name==='analytics') loadAnalytics();
      if (name==='overview') filterAdminData();
    }
    function loadAdminData(){ filterAdminData(); loadAdminSales(); loadAdminExpenses(); loadAnalytics(); }

    function filterAdminData(){
      const selected = document.getElementById('adminDateFilter').value;
      const t = new Date(selected);
      const sSales = salesData.filter(x=> new Date(x.date).toDateString()===t.toDateString());
      const sExp = expensesData.filter(x=> new Date(x.date).toDateString()===t.toDateString());
      const sPay = paymentsData.filter(x=> new Date(x.date).toDateString()===t.toDateString());
      const totalSales = sSales.reduce((sum,s)=> sum + (s.paidAmount||0), 0) + sPay.reduce((sum,p)=> sum+p.amount,0);
      const totalExp = sExp.reduce((sum,e)=> sum+e.amount,0);
      const net = totalSales - totalExp;
      const trx = sSales.length + sExp.length + sPay.length;
      document.getElementById('adminTotalSales').textContent = totalSales.toLocaleString('tr-TR');
      document.getElementById('adminTotalExpenses').textContent = totalExp.toLocaleString('tr-TR');
      document.getElementById('adminNetProfit').textContent = net.toLocaleString('tr-TR');
      document.getElementById('adminTotalTransactions').textContent = String(trx);
    }

    function loadAdminSales(){
      const selected = document.getElementById('salesDateFilter').value;
      const t = new Date(selected);
      const rows = salesData.filter(s=> new Date(s.date).toDateString()===t.toDateString());
      const tbody = document.getElementById('adminSalesTable');
      tbody.innerHTML = rows.map(s=>`
        <tr>
          <td>${new Date(s.date).toLocaleDateString('tr-TR')}</td>
          <td>${s.customerName} ${s.customerSurname}</td>
          <td>${s.productCode || '-'} ${s.productName? ' - '+s.productName:''}</td>
          <td>${s.quantity ?? '-'}</td>
          <td>${s.salePrice.toLocaleString('tr-TR')} â‚º</td>
          <td><span class="status-badge status-active">${getPaymentTypeDisplay(s.paidPaymentType)}</span></td>
          <td>${s.employee}</td>
          <td class="d-flex gap-1">
            <button class="btn btn-warning btn-small" onclick="editSale(${s.id})">DÃ¼zenle</button>
            <button class="btn btn-danger btn-small" onclick="deleteSale(${s.id})">Sil</button>
          </td>
        </tr>
      `).join('');
    }

    function loadAdminExpenses(){
      const selected = document.getElementById('expensesDateFilter').value;
      const t = new Date(selected);
      const rows = expensesData.filter(e=> new Date(e.date).toDateString()===t.toDateString());
      const tbody = document.getElementById('adminExpensesTable');
      tbody.innerHTML = rows.map(e=>`
        <tr>
          <td>${new Date(e.date).toLocaleDateString('tr-TR')}</td>
          <td>${e.description}</td>
          <td>${e.category}</td>
          <td>${e.amount.toLocaleString('tr-TR')} â‚º</td>
          <td>${e.employee}</td>
          <td class="d-flex gap-1">
            <button class="btn btn-warning btn-small" onclick="editExpense(${e.id})">DÃ¼zenle</button>
            <button class="btn btn-danger btn-small" onclick="deleteExpense(${e.id})">Sil</button>
          </td>
        </tr>
      `).join('');
    }

    // Employees UI
    function loadEmployees(){
      const grid = document.getElementById('employeeGrid');
      grid.innerHTML = Object.entries(employees).map(([code,name])=>`
        <div class="product-card">
          <div class="product-title">${name}</div>
          <div class="product-code">Kod: ${code}</div>
          <button class="btn btn-danger btn-small mt-1" onclick="removeEmployee('${code}')">Sil</button>
        </div>
      `).join('');
    }
    function showAddEmployeeModal(){ document.getElementById('addEmployeeModal').style.display='block'; }
    function closeAddEmployeeModal(){ document.getElementById('addEmployeeModal').style.display='none'; document.getElementById('addEmployeeForm').reset(); }
    document.getElementById('addEmployeeForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = document.getElementById('employeeName').value.trim();
      const code = document.getElementById('employeeCodeNew').value.trim();
      if (!name || !code){ showAlert('GeÃ§ersiz bilgi','error'); return; }
      if (employees[code]){ showAlert('Bu kod kullanÄ±mda','error'); return; }
      employees[code] = name;
      await autoSave();
      loadEmployees();
      closeAddEmployeeModal();
      showAlert('Yeni Ã§alÄ±ÅŸan eklendi','success');
    });
    async function removeEmployee(code){
      if (!confirm('Bu Ã§alÄ±ÅŸanÄ± silmek istiyor musunuz?')) return;
      delete employees[code];
      await autoSave();
      loadEmployees();
      showAlert('Ã‡alÄ±ÅŸan silindi','success');
    }

    // Analytics
    function loadAnalytics(){
      const avg = salesData.length ? (salesData.reduce((s,x)=> s + (x.salePrice||0), 0)/salesData.length) : 0;
      const counts = {};
      salesData.forEach(s=> counts[s.employee] = (counts[s.employee]||0)+1);
      const topEmp = Object.keys(counts).reduce((a,b)=> counts[a]>counts[b]?a:b, '-') || '-';

      const now = new Date();
      const m = now.getMonth(), y = now.getFullYear();
      const thisMonthTotal = salesData.filter(s=> {
        const d = new Date(s.date);
        return d.getMonth()===m && d.getFullYear()===y;
      }).reduce((sum,s)=> sum + (s.salePrice||0), 0);
      const lastMonthTotal = salesData.filter(s=>{
        const d = new Date(s.date);
        return d.getMonth()===(m-1) && d.getFullYear()===y;
      }).reduce((sum,s)=> sum + (s.salePrice||0), 0);
      const growth = lastMonthTotal>0 ? ((thisMonthTotal-lastMonthTotal)/lastMonthTotal*100) : 0;

      document.getElementById('analyticsAvgSale').textContent = avg.toLocaleString('tr-TR');
      document.getElementById('analyticsTopEmployee').textContent = topEmp;
      document.getElementById('analyticsMonthlyGrowth').textContent = growth.toFixed(1)+'%';
      document.getElementById('analyticsCustomerCount').textContent = customersData.length;
    }

    // Sales submit
    document.getElementById('salesForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const empCode = document.getElementById('employeeCode').value;
      const empName = verifyEmployeeCode(empCode);
      if (!empName){ showAlert('GeÃ§ersiz Ã§alÄ±ÅŸan kodu','error'); return; }

      const productCode = document.getElementById('productSelect').value;
      const product = productsData.find(p=> p.code===productCode);
      if (!product){ showAlert('ÃœrÃ¼n seÃ§in','error'); return; }

      const quantity = parseInt(document.getElementById('quantity').value,10);
      const unitPrice = parseFloat(document.getElementById('unitPrice').value);
      const salePrice = parseFloat(document.getElementById('salePrice').value);

      if (isNaN(quantity) || quantity<=0){ showAlert('GeÃ§ersiz adet','error'); return; }
      if (isNaN(unitPrice) || isNaN(salePrice) || salePrice<=0){ showAlert('GeÃ§ersiz fiyat','error'); return; }
      if (product.stock < quantity){ showAlert(`Yetersiz stok. Mevcut: ${product.stock}`,'error'); return; }

      const customerName = document.getElementById('customerName').value.trim();
      const customerSurname = document.getElementById('customerSurname').value.trim();
      const customerPhone = document.getElementById('customerPhone').value.trim();
      if (!customerName || !customerSurname || !customerPhone){ showAlert('MÃ¼ÅŸteri bilgileri eksik','error'); return; }

      const paidAmount = selectedPaymentType==='debt' ? parseFloat(document.getElementById('paidAmount').value||'0') : salePrice;
      if (isNaN(paidAmount) || paidAmount<0 || paidAmount>salePrice){ showAlert('GeÃ§ersiz Ã¶denen tutar','error'); return; }

      const saleData = {
        id: Date.now(),
        date: new Date().toISOString(),
        customerName, customerSurname, customerPhone,
        productCode: product.code, productName: product.name,
        quantity, unitPrice, salePrice,
        paymentType: selectedPaymentType,
        paidAmount,
        paidPaymentType: (selectedPaymentType==='debt') ? selectedPaidPaymentType : selectedPaymentType,
        employee: empName, employeeCode: empCode
      };

      // Kaydet
      salesData.push(saleData);
      updateCustomer(customerName, customerSurname, customerPhone, saleData);

      // Stok dÃ¼ÅŸ
      product.stock -= quantity;
      stockMovements.push({ id: Date.now()+1, date:new Date().toISOString(), productCode: product.code, change: -quantity, reason:'SatÄ±ÅŸ', employee: empName });

      if (selectedPaymentType==='debt' && paidAmount < salePrice){
        debtsData.push({
          id: Date.now()+2, saleId: saleData.id,
          customerName, customerSurname, customerPhone,
          totalAmount: salePrice, paidAmount, remainingAmount: salePrice - paidAmount,
          date: saleData.date, employee: empName
        });
      }

      await autoSave();
      showAlert('SatÄ±ÅŸ kaydedildi','success');
      document.getElementById('salesForm').reset();
      selectPaymentType('cash'); selectedPaidPaymentType='cash';
      fillProductsToSelect();
      renderWarehouse();
      updateDashboard();
      updateDebtBadge();
      loadCustomers();
      if (isAdminLoggedIn) loadAdminData();
    });

    // Expenses
    document.getElementById('expensesForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const code = document.getElementById('expenseEmployeeCode').value;
      const emp = verifyEmployeeCode(code);
      if (!emp){ showAlert('GeÃ§ersiz Ã§alÄ±ÅŸan kodu','error'); return; }
      const expenseData = {
        id: Date.now(), date:new Date().toISOString(),
        description: document.getElementById('expenseDescription').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        category: document.getElementById('expenseCategory').value,
        employee: emp, employeeCode: code
      };
      expensesData.push(expenseData);
      await autoSave();
      showAlert('Gider kaydedildi','success');
      document.getElementById('expensesForm').reset();
      updateDashboard();
      if (isAdminLoggedIn) loadAdminData();
    });

    // Dashboard
    function updateDashboard(){
      const { startDate, endDate } = getDateRange(currentDashboardPeriod);
      const sSales = salesData.filter(s=> { const d=new Date(s.date); return d>=startDate && d<endDate; });
      const sExp = expensesData.filter(e=> { const d=new Date(e.date); return d>=startDate && d<endDate; });
      const sPay = paymentsData.filter(p=> { const d=new Date(p.date); return d>=startDate && d<endDate; });

      const incomeSales = sSales.reduce((sum,s)=> sum + (s.paidAmount||0), 0);
      const incomePays = sPay.reduce((sum,p)=> sum + p.amount, 0);
      const totalIncome = incomeSales + incomePays;
      const totalExpenses = sExp.reduce((sum,e)=> sum + e.amount, 0);
      const totalDebt = debtsData.reduce((sum,d)=> sum + d.remainingAmount, 0);
      const net = totalIncome - totalExpenses;

      document.getElementById('totalSales').textContent = totalIncome.toLocaleString('tr-TR');
      document.getElementById('totalExpenses').textContent = totalExpenses.toLocaleString('tr-TR');
      document.getElementById('netProfit').textContent = net.toLocaleString('tr-TR');
      document.getElementById('totalDebt').textContent = totalDebt.toLocaleString('tr-TR');

      const profitChangeEl = document.getElementById('profitChange');
      if (net>0){ profitChangeEl.className='stat-change positive'; profitChangeEl.textContent = '+'+((net/(totalIncome||1))*100).toFixed(1)+'%'; }
      else if (net<0){ profitChangeEl.className='stat-change negative'; profitChangeEl.textContent = ((net/(totalIncome||1))*100).toFixed(1)+'%'; }
      else { profitChangeEl.className='stat-change'; profitChangeEl.textContent='0%'; }

      updateRecentTransactions();
    }

    function updateRecentTransactions(){
      const all = [
        ...salesData.map(s=>({ date:s.date, type:'SatÄ±ÅŸ', description:`${s.customerName} ${s.customerSurname} - ${s.productCode} x${s.quantity}`, amount:s.paidAmount, paymentType:s.paidPaymentType, employee:s.employee })),
        ...paymentsData.map(p=>({ date:p.date, type:'Ã–deme', description:`${p.customerName} ${p.customerSurname}`, amount:p.amount, paymentType:p.paymentType, employee:p.employee })),
        ...expensesData.map(e=>({ date:e.date, type:'Gider', description:e.description, amount:-e.amount, paymentType:'-', employee:e.employee })),
      ].sort((a,b)=> new Date(b.date)-new Date(a.date)).slice(0,10);
      const tbody = document.getElementById('recentTransactions');
      tbody.innerHTML = all.map(t=>`
        <tr>
          <td>${new Date(t.date).toLocaleDateString('tr-TR')}</td>
          <td>${t.type}</td>
          <td>${t.description}</td>
          <td style="color:${t.amount>=0?'var(--success-color)':'var(--danger-color)'}">${t.amount>=0?'+':''}${t.amount.toLocaleString('tr-TR')} â‚º</td>
          <td>${t.paymentType!=='-'? `<span class="status-badge status-active">${getPaymentTypeDisplay(t.paymentType)}</span>`:'-'}</td>
          <td>${t.employee}</td>
        </tr>
      `).join('');
    }

    // Debts / Payments
    function showPendingPayments(){
      const list = document.getElementById('pendingPaymentsList');
      list.innerHTML = debtsData.map(d=>`
        <div class="customer-item ripple" onclick="showPaymentModal('${d.customerPhone}')" style="border-left:4px solid var(--danger-color);">
          <div class="customer-name">${d.customerName} ${d.customerSurname}</div>
          <div class="customer-info">
            <span>ðŸ“ž ${d.customerPhone}</span>
            <span>Toplam: ${d.totalAmount.toLocaleString('tr-TR')} â‚º</span>
            <span>Ã–denen: ${d.paidAmount.toLocaleString('tr-TR')} â‚º</span>
            <span style="color:var(--danger-color); font-weight:800;">Kalan: ${d.remainingAmount.toLocaleString('tr-TR')} â‚º</span>
          </div>
        </div>
      `).join('');
      document.getElementById('paymentsModal').style.display='block';
    }

    function showPaymentModal(phone){
      const debt = debtsData.find(d=> d.customerPhone===phone);
      if (!debt) return;
      currentPaymentCustomer = debt;
      document.getElementById('paymentCustomerInfo').textContent = `${debt.customerName} ${debt.customerSurname} (${debt.customerPhone})`;
      document.getElementById('paymentTotalDebt').textContent = `${debt.remainingAmount.toLocaleString('tr-TR')} â‚º`;
      document.getElementById('paymentAmount').value = debt.remainingAmount;
      selectedDebtPaymentType='cash';
      document.querySelectorAll('#paymentModal .payment-option').forEach(o=>o.classList.remove('selected'));
      document.querySelector('#paymentModal .payment-option').classList.add('selected');
      document.getElementById('paymentsModal').style.display='none';
      document.getElementById('paymentModal').style.display='block';
    }

    async function processPayment(){
      const code = document.getElementById('paymentEmployeeCode').value;
      const emp = verifyEmployeeCode(code);
      if (!emp){ showAlert('GeÃ§ersiz Ã§alÄ±ÅŸan kodu','error'); return; }
      const amount = parseFloat(document.getElementById('paymentAmount').value);
      if (!currentPaymentCustomer || isNaN(amount) || amount<=0 || amount>currentPaymentCustomer.remainingAmount){ showAlert('GeÃ§ersiz Ã¶deme tutarÄ±','error'); return; }
      const idx = debtsData.findIndex(d=> d.id===currentPaymentCustomer.id);
      if (idx>-1){
        debtsData[idx].paidAmount += amount;
        debtsData[idx].remainingAmount -= amount;
        if (debtsData[idx].remainingAmount<=0){ debtsData.splice(idx,1); }
      }
      paymentsData.push({
        id: Date.now(), date:new Date().toISOString(),
        customerName: currentPaymentCustomer.customerName, customerSurname: currentPaymentCustomer.customerSurname, customerPhone: currentPaymentCustomer.customerPhone,
        amount, paymentType: selectedDebtPaymentType, type:'debt_payment', employee: emp, debtId: currentPaymentCustomer.id
      });
      await autoSave();
      showAlert('Ã–deme alÄ±ndÄ±','success');
      closePaymentModal();
      updateDashboard();
      updateDebtBadge();
    }

    // Edit/Delete Sale
    function editSale(id){
      const s = salesData.find(x=>x.id===id); if (!s) return;
      currentEditSaleId = id;
      document.getElementById('editCustomerName').value = s.customerName;
      document.getElementById('editCustomerSurname').value = s.customerSurname;
      document.getElementById('editCustomerPhone').value = s.customerPhone;
      document.getElementById('editQuantity').value = s.quantity ?? 1;
      document.getElementById('editUnitPrice').value = s.unitPrice ?? 0;
      document.getElementById('editSalePrice').value = s.salePrice ?? 0;
      document.getElementById('editSaleModal').style.display='block';
    }
    function closeEditSale(){ currentEditSaleId=null; document.getElementById('editSaleModal').style.display='none'; }

    document.getElementById('editSaleForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const idx = salesData.findIndex(s=> s.id===currentEditSaleId); if (idx===-1) return;
      const old = { ...salesData[idx] };

      const newQty = parseInt(document.getElementById('editQuantity').value,10);
      const newUnit = parseFloat(document.getElementById('editUnitPrice').value);
      const newTotal = parseFloat(document.getElementById('editSalePrice').value);
      const newName = document.getElementById('editCustomerName').value;
      const newSurname = document.getElementById('editCustomerSurname').value;
      const newPhone = document.getElementById('editCustomerPhone').value;

      if (isNaN(newQty)||newQty<=0 || isNaN(newUnit)||newUnit<0 || isNaN(newTotal)||newTotal<=0){ showAlert('GeÃ§ersiz deÄŸer','error'); return; }

      // Stok dengelemesi: miktar deÄŸiÅŸtiyse stok farkÄ±nÄ± uygula
      const prod = productsData.find(p=> p.code===old.productCode);
      if (prod){
        const delta = newQty - (old.quantity||0);
        if (delta>0 && prod.stock<delta){ showAlert(`Yetersiz stok. Mevcut: ${prod.stock}`,'error'); return; }
        if (delta!==0){
          prod.stock -= delta;
          stockMovements.push({ id: Date.now(), date:new Date().toISOString(), productCode:prod.code, change:-delta, reason:'SatÄ±ÅŸ DÃ¼zeltme', employee: old.employee });
        }
      }

      // GÃ¼ncelle
      salesData[idx].customerName = newName;
      salesData[idx].customerSurname = newSurname;
      salesData[idx].customerPhone = newPhone;
      salesData[idx].quantity = newQty;
      salesData[idx].unitPrice = newUnit;
      salesData[idx].salePrice = newTotal;

      // BorÃ§ durumunu dÃ¼zelt
      const existingDebtIdx = debtsData.findIndex(d=> d.saleId===currentEditSaleId);
      const remaining = (salesData[idx].salePrice||0) - (salesData[idx].paidAmount||0);
      if (remaining>0){
        if (existingDebtIdx>-1){
          debtsData[existingDebtIdx].customerName = newName;
          debtsData[existingDebtIdx].customerSurname = newSurname;
          debtsData[existingDebtIdx].customerPhone = newPhone;
          debtsData[existingDebtIdx].totalAmount = salesData[idx].salePrice;
          debtsData[existingDebtIdx].remainingAmount = remaining;
        }else{
          debtsData.push({
            id: Date.now(), saleId: currentEditSaleId, customerName:newName, customerSurname:newSurname, customerPhone:newPhone,
            totalAmount:salesData[idx].salePrice, paidAmount:salesData[idx].paidAmount||0, remainingAmount:remaining, date:salesData[idx].date, employee:salesData[idx].employee
          });
        }
      }else if (existingDebtIdx>-1){
        debtsData.splice(existingDebtIdx,1);
      }

      // MÃ¼ÅŸteri toplamlarÄ±nÄ± dÃ¼zelt
      updateCustomerAfterSaleEdit(old, salesData[idx]);

      await autoSave();
      loadAdminData(); updateDashboard(); updateDebtBadge(); closeEditSale(); showAlert('SatÄ±ÅŸ gÃ¼ncellendi','success');
    });

    async function deleteSale(id){
      if (!confirm('Bu satÄ±ÅŸÄ± silmek istiyor musunuz?')) return;
      const idx = salesData.findIndex(s=> s.id===id);
      if (idx===-1) return;
      const sale = salesData[idx];

      // Stok iade et
      const prod = productsData.find(p=> p.code===sale.productCode);
      if (prod && sale.quantity){
        prod.stock += sale.quantity;
        stockMovements.push({ id: Date.now(), date:new Date().toISOString(), productCode:prod.code, change: sale.quantity, reason:'SatÄ±ÅŸ Silme (Stok Ä°ade)', employee: sale.employee });
      }

      salesData.splice(idx,1);
      const dIdx = debtsData.findIndex(d=> d.saleId===id);
      if (dIdx>-1) debtsData.splice(dIdx,1);

      updateCustomerAfterSaleDelete(sale);
      await autoSave();
      loadAdminData(); updateDashboard(); updateDebtBadge(); renderWarehouse();
      showAlert('SatÄ±ÅŸ silindi','success');
    }

    function updateCustomerAfterSaleDelete(sale){
      const cIdx = customersData.findIndex(c=> c.phone===sale.customerPhone);
      if (cIdx>-1){
        const c = customersData[cIdx];
        c.sales = c.sales.filter(s=> s.id!==sale.id);
        c.totalPurchases -= sale.salePrice;
        if (c.sales.length===0) customersData.splice(cIdx,1);
        else c.lastPurchase = c.sales[c.sales.length-1].date;
      }
    }

    function updateCustomerAfterSaleEdit(oldSale, newSale){
      // Eski mÃ¼ÅŸteri kaydÄ±nÄ± gÃ¼ncelle
      const idx = customersData.findIndex(c=> c.phone===oldSale.customerPhone);
      if (idx>-1){
        const c = customersData[idx];
        const sIdx = c.sales.findIndex(s=> s.id===newSale.id);
        if (sIdx>-1){
          c.totalPurchases = c.totalPurchases - oldSale.salePrice + newSale.salePrice;
          c.sales[sIdx] = { ...newSale };
          if (oldSale.customerPhone !== newSale.customerPhone){
            // Eski mÃ¼ÅŸteriden kaldÄ±r, yeni mÃ¼ÅŸteriye ekle
            c.sales.splice(sIdx,1);
            c.totalPurchases -= newSale.salePrice;
            if (c.sales.length===0) customersData.splice(idx,1);
            updateCustomer(newSale.customerName, newSale.customerSurname, newSale.customerPhone, newSale);
          }else{
            c.lastPurchase = c.sales[c.sales.length-1]?.date || c.lastPurchase;
          }
        }
      }else{
        // yoksa direkt yeni mÃ¼ÅŸteriye ekle
        updateCustomer(newSale.customerName, newSale.customerSurname, newSale.customerPhone, newSale);
      }
    }

    // Expenses edit/delete
    function editExpense(id){
      const e = expensesData.find(x=> x.id===id); if (!e) return;
      currentEditExpenseId = id;
      document.getElementById('editExpenseDescription').value = e.description;
      document.getElementById('editExpenseAmount').value = e.amount;
      document.getElementById('editExpenseCategory').value = e.category;
      document.getElementById('editExpenseModal').style.display='block';
    }
    function closeEditExpense(){ currentEditExpenseId=null; document.getElementById('editExpenseModal').style.display='none'; }
    document.getElementById('editExpenseForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const idx = expensesData.findIndex(x=> x.id===currentEditExpenseId); if (idx===-1) return;
      expensesData[idx].description = document.getElementById('editExpenseDescription').value;
      expensesData[idx].amount = parseFloat(document.getElementById('editExpenseAmount').value);
      expensesData[idx].category = document.getElementById('editExpenseCategory').value;
      await autoSave();
      loadAdminData(); updateDashboard(); closeEditExpense(); showAlert('Gider gÃ¼ncellendi','success');
    });
    async function deleteExpense(id){
      if (!confirm('Bu gideri silmek istiyor musunuz?')) return;
      const idx = expensesData.findIndex(x=> x.id===id);
      if (idx>-1){ expensesData.splice(idx,1); await autoSave(); loadAdminData(); updateDashboard(); showAlert('Gider silindi','success'); }
    }

    // Reports
    function generateReport(){
      const type = document.getElementById('reportType').value;
      const dateVal = document.getElementById('reportDate').value || new Date().toISOString().split('T')[0];
      const target = new Date(dateVal);

      function filterBy(range){
        const [check] = range;
        return check;
      }

      function filterSet(arr){
        if (type==='daily'){ return arr.filter(x=> new Date(x.date).toDateString()===target.toDateString()); }
        if (type==='monthly'){ return arr.filter(x=> { const d=new Date(x.date); return d.getMonth()===target.getMonth() && d.getFullYear()===target.getFullYear(); }); }
        return arr.filter(x=> new Date(x.date).getFullYear()===target.getFullYear());
      }

      const sSales = filterSet(salesData);
      const sExp = filterSet(expensesData);
      const sDebts = filterSet(debtsData);
      const sPays = filterSet(paymentsData);

      const income = sSales.reduce((sum,s)=> sum + (s.paidAmount||0), 0) + sPays.reduce((sum,p)=> sum + p.amount, 0);
      const exp = sExp.reduce((sum,e)=> sum + e.amount, 0);
      const debt = sDebts.reduce((sum,d)=> sum + d.remainingAmount, 0);

      // ÃœrÃ¼n satÄ±ÅŸ Ã¶zeti
      const productAgg = {};
      sSales.forEach(s=>{
        if (!s.productCode) return;
        if (!productAgg[s.productCode]) productAgg[s.productCode]={ code:s.productCode, name:s.productName||'', qty:0, total:0 };
        productAgg[s.productCode].qty += (s.quantity||0);
        productAgg[s.productCode].total += (s.salePrice||0);
      });
      const productRows = Object.values(productAgg).sort((a,b)=> b.qty-a.qty);

      // Stok hareketleri (aynÄ± dÃ¶nem)
      const periodStockMovs = filterSet(stockMovements);

      document.getElementById('reportContent').innerHTML = `
        <div class="card">
          <div class="card-header"><h3 class="card-title">${type==='daily'?'GÃ¼nlÃ¼k':type==='monthly'?'AylÄ±k':'YÄ±llÄ±k'} Rapor</h3></div>
          <div class="card-content">
            <div class="stats-grid mb-2">
              <div class="stat-card ripple"><div class="stat-header"><span>Toplam Gelir</span>â‚º</div><div class="stat-value">${income.toLocaleString('tr-TR')}</div></div>
              <div class="stat-card ripple"><div class="stat-header"><span>Gider</span>â‚º</div><div class="stat-value">${exp.toLocaleString('tr-TR')}</div></div>
              <div class="stat-card ripple"><div class="stat-header"><span>Kar</span>â‚º</div><div class="stat-value">${(income-exp).toLocaleString('tr-TR')}</div></div>
              <div class="stat-card ripple"><div class="stat-header"><span>BorÃ§</span>âš </div><div class="stat-value">${debt.toLocaleString('tr-TR')}</div></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h4 class="card-title">Ä°ÅŸlem DetaylarÄ±</h4></div>
          <div class="card-content" style="padding:0;">
            <div class="table-container">
              <table>
                <thead><tr><th>Tarih</th><th>TÃ¼r</th><th>AÃ§Ä±klama</th><th>Tutar</th><th>Ã–deme</th><th>Ã‡alÄ±ÅŸan</th></tr></thead>
                <tbody>
                ${[
                  ...sSales.map(s=>({ date:s.date, type:'SatÄ±ÅŸ', desc:`${s.customerName} ${s.customerSurname} - ${s.productCode||''} x${s.quantity||''}`, amount:s.paidAmount, pay:getPaymentTypeDisplay(s.paidPaymentType), emp:s.employee })),
                  ...sPays.map(p=>({ date:p.date, type:'Ã–deme', desc:`${p.customerName} ${p.customerSurname}`, amount:p.amount, pay:getPaymentTypeDisplay(p.paymentType), emp:p.employee })),
                  ...sExp.map(e=>({ date:e.date, type:'Gider', desc:e.description, amount:-e.amount, pay:'-', emp:e.employee }))
                ].sort((a,b)=> new Date(b.date)-new Date(a.date)).map(r=>`
                  <tr>
                    <td>${new Date(r.date).toLocaleDateString('tr-TR')}</td>
                    <td>${r.type}</td>
                    <td>${r.desc}</td>
                    <td style="color:${r.amount>=0?'var(--success-color)':'var(--danger-color)'}">${r.amount>=0?'+':''}${r.amount.toLocaleString('tr-TR')} â‚º</td>
                    <td>${r.pay||'-'}</td>
                    <td>${r.emp}</td>
                  </tr>
                `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        ${productRows.length?`
        <div class="card">
          <div class="card-header"><h4 class="card-title">ÃœrÃ¼n SatÄ±ÅŸ Ã–zeti</h4></div>
          <div class="card-content" style="padding:0;">
            <div class="table-container">
              <table>
                <thead><tr><th>Kod</th><th>Ad</th><th>Adet</th><th>Toplam</th></tr></thead>
                <tbody>
                ${productRows.map(p=>`
                  <tr>
                    <td>${p.code}</td>
                    <td>${p.name}</td>
                    <td>${p.qty}</td>
                    <td>${p.total.toLocaleString('tr-TR')} â‚º</td>
                  </tr>
                `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>`:''}

        ${periodStockMovs.length?`
        <div class="card">
          <div class="card-header"><h4 class="card-title">Stok Hareketleri</h4></div>
          <div class="card-content" style="padding:0;">
            <div class="table-container">
              <table>
                <thead><tr><th>Tarih</th><th>ÃœrÃ¼n</th><th>DeÄŸiÅŸim</th><th>Sebep</th><th>Ã‡alÄ±ÅŸan</th></tr></thead>
                <tbody>
                ${periodStockMovs.sort((a,b)=> new Date(b.date)-new Date(a.date)).map(m=>{
                  const p = productsData.find(x=> x.code===m.productCode);
                  return `
                    <tr>
                      <td>${new Date(m.date).toLocaleDateString('tr-TR')}</td>
                      <td>${m.productCode} ${p? '- '+p.name:''}</td>
                      <td style="color:${m.change>=0?'var(--success-color)':'var(--danger-color)'}">${m.change>=0?'+':''}${m.change}</td>
                      <td>${m.reason||'-'}</td>
                      <td>${m.employee||'-'}</td>
                    </tr>
                  `;
                }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>`:''}
      `;
    }

    function downloadReport(){
      const content = document.getElementById('reportContent');
      if (!content.innerHTML){ showAlert('Ã–nce rapor oluÅŸturun','error'); return; }
      const type = document.getElementById('reportType').value;
      const w = window.open('', '_blank');
      w.document.write(`
        <html><head><title>ERT HALI - ${type} Rapor</title>
        <style>
          body{ font-family:Arial, sans-serif; margin:20px; color:#000; }
          table{ width:100%; border-collapse:collapse; margin:20px 0; }
          th,td{ border:1px solid #ddd; padding:8px; text-align:left; }
          th{ background:#f2f2f2; }
          .stats-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin:20px 0;}
          .stat-card{ border:1px solid #ddd; padding:16px; text-align:center; }
          .stat-value{ font-size:22px; font-weight:bold; }
        </style>
        </head><body>
          <h1>ERT HALI</h1>
          ${content.innerHTML}
        </body></html>
      `);
      w.document.close();
      w.print();
    }

    // Modals close
    function closeCustomerModal(){ document.getElementById('customerModal').style.display='none'; }
    function closePaymentsModal(){ document.getElementById('paymentsModal').style.display='none'; }
    function closePaymentModal(){ document.getElementById('paymentModal').style.display='none'; document.getElementById('paymentEmployeeCode').value=''; currentPaymentCustomer=null; }

    // Clear data
    async function clearAllData(){
      if (!confirm('TÃ¼m verileri silmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz!')) return;
      initializeEmptyData();
      await autoSave();
      hydrateUIFromData();
      showAlert('TÃ¼m veriler temizlendi','success');
    }

    // Window behaviors
    window.addEventListener('resize', ()=>{ if (window.innerWidth>=1024){ sidebar.classList.remove('open'); overlay.classList.remove('show'); } });
    window.addEventListener('click', (e)=>{
      document.querySelectorAll('.modal').forEach(m=>{
        if (e.target===m){ m.style.display='none'; }
      });
    });

    // Init
    function updateDatesDefaults(){
      const today = new Date().toISOString().split('T')[0];
      const ids = ['reportDate','adminDateFilter','salesDateFilter','expensesDateFilter'];
      ids.forEach(id=>{ const el=document.getElementById(id); if (el) el.value=today; });
    }

    function initApp(){
      if (!isFileSystemSupported) showFileStatus('File System API desteklenmiyor','warning');
      else showFileStatus('File System API hazÄ±r','success');

      loadTheme();
      updateDatesDefaults();
      updateDashboard();
      updateDebtBadge();
      setupCustomerAutocomplete();
      fillProductsToSelect();
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
