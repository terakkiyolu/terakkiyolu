<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yerel Dosya ile Çalış</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; padding: 24px; background: #0b1220; color: #e6edf3; }
    .wrap { max-width: 900px; margin: 0 auto; }
    .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 16px; padding: 20px; box-shadow: 0 8px 30px rgba(0,0,0,.25); }
    h1 { margin: 0 0 12px; font-size: 24px; }
    .hint { color: #94a3b8; font-size: 14px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin: 12px 0; }
    button { cursor: pointer; border: 1px solid #334155; background: #111827; color: #e5e7eb; padding: 10px 14px; border-radius: 12px; font-weight: 600; }
    button:hover { background: #0b1220; }
    button.primary { background: #2563eb; border-color: #1d4ed8; }
    button.primary:hover { filter: brightness(1.05); }
    textarea { width: 100%; min-height: 320px; resize: vertical; border-radius: 12px; border: 1px solid #334155; background: #0b1220; color: #e6edf3; padding: 12px; box-sizing: border-box; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .status { font-size: 13px; color: #a5b4fc; margin-top: 8px; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 10px; border: 1px solid #334155; background: #0b1220; color: #cbd5e1; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Yerel Dosya ile Çalış (File System Access API)</h1>
      <p class="hint">
        İlk seferde dosyayı seçip izin verirsiniz; sonraki girişlerde aynı sitede otomatik açılır.
        Bu özellik Chromium tabanlı tarayıcılarda (Chrome/Edge/Opera/Brave) ve <strong>HTTPS</strong> veya <strong>localhost</strong> üzerinde çalışır.
      </p>
      <div class="row">
        <button id="choose" class="primary">Dosya Seç</button>
        <button id="save">Kaydet</button>
        <button id="change">Farklı Dosya Seç</button>
        <span id="filename" class="badge">Dosya: Yok</span>
      </div>
      <textarea id="editor" placeholder="Dosya içeriği burada görünecek..."></textarea>
      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    // —— Basit IndexedDB yardımcıları ——
    const DB_NAME = 'local-file-demo';
    const STORE = 'handles';

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = () => {
          req.result.createObjectStore(STORE);
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function idbSet(key, value) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, 'readwrite');
        tx.objectStore(STORE).put(value, key);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
    }

    async function idbGet(key) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, 'readonly');
        const req = tx.objectStore(STORE).get(key);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    // —— File System Access yardımcıları ——
    async function verifyPermission(fileHandle, withWrite) {
      const opts = { mode: withWrite ? 'readwrite' : 'read' };
      if ((await fileHandle.queryPermission(opts)) === 'granted') return true;
      if ((await fileHandle.requestPermission(opts)) === 'granted') return true;
      return false;
    }

    async function pickFile() {
      const [handle] = await window.showOpenFilePicker({
        types: [{ description: 'Metin veya tüm dosyalar', accept: { 'text/plain': ['.txt', '.md', '.log'], 'application/octet-stream': ['.*'] } }],
        excludeAcceptAllOption: false,
        multiple: false
      });
      await idbSet('fileHandle', handle);
      return handle;
    }

    async function loadFromHandle(handle) {
      const ok = await verifyPermission(handle, false);
      if (!ok) throw new Error('İzin verilmedi.');
      const file = await handle.getFile();
      const text = await file.text();
      editor.value = text;
      filename.textContent = 'Dosya: ' + (file.name || '(adı bilinmiyor)');
      status('Dosya yüklendi.');
    }

    async function saveToHandle(handle) {
      const ok = await verifyPermission(handle, true);
      if (!ok) throw new Error('Yazma izni verilmedi.');
      const writable = await handle.createWritable();
      await writable.write(editor.value);
      await writable.close();
      status('Kaydedildi ✓');
    }

    // —— UI ——
    const chooseBtn = document.getElementById('choose');
    const saveBtn = document.getElementById('save');
    const changeBtn = document.getElementById('change');
    const editor = document.getElementById('editor');
    const filename = document.getElementById('filename');
    const statusEl = document.getElementById('status');

    function status(msg) { statusEl.textContent = msg; }

    function supported() {
      return 'showOpenFilePicker' in window && 'storage' in navigator;
    }

    async function boot() {
      if (!supported()) {
        status('Tarayıcınız File System Access API'yi desteklemiyor. Lütfen Chrome/Edge kullanın.');
        return;
      }
      try {
        const saved = await idbGet('fileHandle');
        if (saved) {
          // Bazı tarayıcılarda kalıcı izin doğrudan "granted" gelir ve yeniden seçim gerekmez.
          await loadFromHandle(saved);
        } else {
          status('Başlamak için "Dosya Seç"e tıklayın.');
        }
      } catch (e) {
        console.error(e);
        status('Önceden kayıtlı dosya açılamadı: ' + e.message);
      }
    }

    chooseBtn.addEventListener('click', async () => {
      try {
        const handle = await pickFile();
        await loadFromHandle(handle);
      } catch (e) { status('Seçim iptal edildi veya hata: ' + e.message); }
    });

    saveBtn.addEventListener('click', async () => {
      try {
        const handle = await idbGet('fileHandle');
        if (!handle) return status('Önce bir dosya seçin.');
        await saveToHandle(handle);
      } catch (e) { status('Kaydedilemedi: ' + e.message); }
    });

    changeBtn.addEventListener('click', async () => {
      try {
        const handle = await pickFile();
        await loadFromHandle(handle);
      } catch (e) { status('Seçim iptal edildi veya hata: ' + e.message); }
    });

    // PWA olarak kuruluysa izinler daha kararlı olabilir
    window.addEventListener('load', boot);
  </script>
</body>
</html>
