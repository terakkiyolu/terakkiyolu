<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otel Notları Uygulaması</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #settings-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
        }
        #notes-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .note-card {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        .note-room {
            background-color: #ffcc00;
            color: #333;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 10px;
        }
        .note-content {
            margin-bottom: 10px;
        }
        .note-expiry {
            font-size: 0.85em;
            color: #666;
        }
        #add-note-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        #settings-modal, #add-note-modal, #file-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            margin-right: 10px;
        }
        #expired-notes {
            margin-top: 40px;
            padding: 20px;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
        }
        #expired-notes h2 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <header>
        <button id="settings-btn">⚙️ Ayarlar</button>
        <h1>Otel Notları</h1>
    </header>

    <p>Notlar seçtiğiniz JSON dosyasına kaydedilir ve oradan yüklenir. Süresi dolan notlar otomatik temizlenir ve süresi geçmişler bölümüne taşınır.</p>

    <button id="add-note-btn">Not Ekle</button>

    <div id="notes-container"></div>

    <div id="expired-notes">
        <h2>Süresi Geçmiş Notlar</h2>
        <div id="expired-container"></div>
    </div>

    <!-- Ayarlar Modal -->
    <div id="settings-modal">
        <div class="modal-content">
            <h2>Ayarlar</h2>
            <p>JSON dosyası: <span id="file-status">seçilmedi</span></p>
            <button id="select-file-btn">JSON Dosyası Seç</button>
            <button id="create-file-btn">Yeni JSON Oluştur</button>
            <button id="close-settings">Kapat</button>
        </div>
    </div>

    <!-- Not Ekle Modal -->
    <div id="add-note-modal">
        <div class="modal-content">
            <h2>Not Ekle</h2>
            <input type="text" id="room-input" placeholder="Oda Numarası (ör: 101)">
            <textarea id="note-input" placeholder="Not İçeriği" rows="4"></textarea>
            <select id="expiry-select">
                <option value="1h">1 Saat</option>
                <option value="1d">1 Gün</option>
                <option value="7d">1 Hafta</option>
            </select>
            <button id="save-note">Kaydet</button>
            <button id="cancel-note">İptal</button>
        </div>
    </div>

    <!-- Dosya Seç Modal (Otomatik açılış için) -->
    <div id="file-modal">
        <div class="modal-content">
            <h2>JSON Dosyası Seç</h2>
            <p>Önceki dosya erişilemiyor. Lütfen tekrar seçin.</p>
            <button id="select-file-modal-btn">JSON Dosyası Seç</button>
            <button id="close-file-modal">Kapat</button>
        </div>
    </div>

    <script>
        let fileHandle = null;
        let notes = [];
        let expiredNotes = [];

        // Süre hesaplama fonksiyonu
        function calculateExpiry(duration) {
            const now = new Date();
            if (duration === '1h') {
                now.setHours(now.getHours() + 1);
            } else if (duration === '1d') {
                now.setDate(now.getDate() + 1);
            } else if (duration === '7d') {
                now.setDate(now.getDate() + 7);
            }
            return now.getTime();
        }

        // Notları render et
        function renderNotes() {
            const container = document.getElementById('notes-container');
            const expiredContainer = document.getElementById('expired-container');
            container.innerHTML = '';
            expiredContainer.innerHTML = '';
            const now = Date.now();

            notes.forEach(note => {
                if (note.expiry > now) {
                    const card = document.createElement('div');
                    card.className = 'note-card';
                    card.innerHTML = `
                        <div class="note-room">Oda: ${note.room}</div>
                        <div class="note-content">${note.content}</div>
                        <div class="note-expiry">Süre: ${new Date(note.expiry).toLocaleString()}</div>
                    `;
                    container.appendChild(card);
                } else {
                    expiredNotes.push(note);
                }
            });

            // Süresi dolanları filtrele ve expired'a taşı
            notes = notes.filter(note => note.expiry > now);

            expiredNotes.forEach(note => {
                const card = document.createElement('div');
                card.className = 'note-card';
                card.innerHTML = `
                    <div class="note-room">Oda: ${note.room}</div>
                    <div class="note-content">${note.content}</div>
                    <div class="note-expiry">Süresi Doldu: ${new Date(note.expiry).toLocaleString()}</div>
                `;
                expiredContainer.appendChild(card);
            });
        }

        // Dosya yükle/kaydet
        async function loadNotes() {
            if (!fileHandle) return;
            try {
                const file = await fileHandle.getFile();
                const text = await file.text();
                const data = JSON.parse(text);
                notes = data.notes || [];
                expiredNotes = data.expiredNotes || [];
                renderNotes();
            } catch (error) {
                console.error('Dosya okuma hatası:', error);
            }
        }

        async function saveNotes() {
            if (!fileHandle) return;
            try {
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify({ notes, expiredNotes }));
                await writable.close();
            } catch (error) {
                console.error('Dosya yazma hatası:', error);
            }
        }

        // Dosya seç
        async function selectFile() {
            try {
                [fileHandle] = await window.showOpenFilePicker({
                    types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }]
                });
                await loadNotes();
                document.getElementById('file-status').textContent = fileHandle.name;
                localStorage.setItem('fileHandle', JSON.stringify(await fileHandle.queryPermission({ mode: 'readwrite' }))); // Handle'ı sakla (ama gerçekte handle saklanamaz, sadece izin)
            } catch (error) {
                console.error('Dosya seçme hatası:', error);
            }
        }

        // Yeni dosya oluştur
        async function createFile() {
            try {
                fileHandle = await window.showSaveFilePicker({
                    suggestedName: 'notes.json',
                    types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }]
                });
                await saveNotes();
                document.getElementById('file-status').textContent = fileHandle.name;
            } catch (error) {
                console.error('Dosya oluşturma hatası:', error);
            }
        }

        // Otomatik dosya yükleme
        async function autoLoadFile() {
            const storedHandle = localStorage.getItem('fileHandle');
            if (storedHandle && fileHandle) {
                const permission = await fileHandle.queryPermission({ mode: 'readwrite' });
                if (permission === 'granted') {
                    await loadNotes();
                } else {
                    document.getElementById('file-modal').style.display = 'flex';
                }
            }
        }

        // Event listeners
        document.getElementById('settings-btn').addEventListener('click', () => {
            document.getElementById('settings-modal').style.display = 'flex';
        });

        document.getElementById('close-settings').addEventListener('click', () => {
            document.getElementById('settings-modal').style.display = 'none';
        });

        document.getElementById('select-file-btn').addEventListener('click', selectFile);
        document.getElementById('select-file-modal-btn').addEventListener('click', selectFile);
        document.getElementById('create-file-btn').addEventListener('click', createFile);

        document.getElementById('add-note-btn').addEventListener('click', () => {
            document.getElementById('add-note-modal').style.display = 'flex';
        });

        document.getElementById('cancel-note').addEventListener('click', () => {
            document.getElementById('add-note-modal').style.display = 'none';
        });

        document.getElementById('save-note').addEventListener('click', () => {
            const room = document.getElementById('room-input').value;
            const content = document.getElementById('note-input').value;
            const expiryDuration = document.getElementById('expiry-select').value;
            if (room && content) {
                notes.push({
                    room,
                    content,
                    expiry: calculateExpiry(expiryDuration)
                });
                renderNotes();
                saveNotes();
                document.getElementById('add-note-modal').style.display = 'none';
                document.getElementById('room-input').value = '';
                document.getElementById('note-input').value = '';
            }
        });

        document.getElementById('close-file-modal').addEventListener('click', () => {
            document.getElementById('file-modal').style.display = 'none';
        });

        // Başlangıçta otomatik yükle
        autoLoadFile();

        // Periyodik olarak süresi dolanları kontrol et (her 1 dakikada)
        setInterval(renderNotes, 60000);
    </script>
</body>
</html>
